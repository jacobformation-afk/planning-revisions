<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planning de RÃ©visions â€” v3 (cloud ready)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#a6b0c3; --text:#e9eef7; --primary:#4caf50; --accent:#2c3e50; --danger:#e74c3c;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue";margin:0;color:var(--text);background:linear-gradient(180deg,#0b1220,#0d1424 35%,#0f1628)}
    header{position:sticky;top:0;z-index:20;background:rgba(11,18,32,.75);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    nav{display:flex;gap:.5rem;align-items:center;max-width:1100px;margin:0 auto;padding:.75rem 1rem}
    nav a, nav button{color:#cfe2ff;text-decoration:none;font-weight:700;padding:.55rem .8rem;border-radius:12px;border:1px solid #223352;background:#1b2942;cursor:pointer}
    nav a[aria-current="page"],nav a:hover,nav button:hover{background:#223352}
    main{max-width:1100px;margin:0 auto;padding:1rem}
    .tab{display:none}.tab.active{display:block}
    .grid{display:grid;gap:1rem}@media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;padding:1rem;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h2{margin:.25rem 0 1rem}
    iframe{border:0;width:100%;border-radius:12px}
    input,select,textarea,button{width:100%;padding:.7rem .8rem;border-radius:12px;border:1px solid #25364f;background:#0f172a;color:var(--text)}
    textarea{min-height:90px}
    button{cursor:pointer;background:#1b8f3f;border:1px solid #1e9a45;font-weight:700}
    button.secondary{background:#1b2942;border-color:#223352}
    button.danger{background:#7a1f1b;border-color:#8a241f}
    .row{display:flex;gap:.5rem;flex-wrap:wrap}.row>*{flex:1 1 220px}
    .list{max-height:420px;overflow:auto}
    .pill{display:inline-flex;align-items:center;gap:.5ch;background:#102038;border:1px solid #223352;border-radius:999px;padding:.35rem .6rem}
    .muted{color:#a6b0c3}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#0b1220;border:1px solid #223352;border-radius:8px;padding:.15rem .4rem}
    .sep{height:1px;background:#1e293b;margin:.75rem 0}
    .hint{font-size:.9rem;color:#a6b0c3}
    .empty{opacity:.7;font-style:italic}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #223352;padding:.5rem;text-align:left}
    th{background:#0f172a}
    .badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;border:1px solid #223352;background:#0f172a;font-size:.85rem}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <nav>
      <strong>ðŸ“š Planning de RÃ©visions</strong>
      <a href="#" data-tab="home" aria-current="page">Accueil</a>
      <a href="#" data-tab="saisies">Saisies du jour</a>
      <a href="#" data-tab="planning">Planning Ã  5 jours</a>
      <a href="#" data-tab="agenda">Agenda</a>
      <a href="#" data-tab="matieres">MatiÃ¨res</a>
      <!-- Boutons Auth -->
      <div style="margin-left:auto; display:flex; gap:.5rem">
        <button id="btnSignIn" class="secondary" type="button">S'identifier</button>
        <button id="btnConnect" class="secondary" type="button" style="display:none">Connecter au cloud</button>
        <button id="btnLogout" class="secondary" type="button" style="display:none">Se dÃ©connecter</button>
      </div>
    </nav>
  </header>

  <main>
    <!-- ACCUEIL -->
    <section class="tab active" id="home">
      <div class="grid">
        <div class="card">
          <h2>Bienvenue ðŸ‘‹</h2>
          <p>Planifie et revois efficacement tes cours. En local par dÃ©faut, connexion cloud optionnelle via Supabase.</p>
          <div class="sep"></div>
          <p class="hint">Astuce : utilise <span class="kbd">Ctrl</span> + <span class="kbd">S</span> pour enregistrer rapidement.</p>
        </div>
        <div class="card">
          <h2>Synchronisation</h2>
          <p><span class="badge">Local</span> â†’ fonctionne hors-ligne. <span class="badge">Cloud</span> â†’ sauvegarde et synchro multi-appareils.</p>
          <ul>
            <li><strong>Sâ€™identifier</strong> : se reconnaÃ®tre via email (OTP).</li>
            <li><strong>Connecter au cloud</strong> : charge tes donnÃ©es en ligne et, si vide, migre les donnÃ©es locales.</li>
            <li><strong>Se dÃ©connecter</strong> : revient au mode local et ferme la session.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- SAISIES -->
    <section class="tab" id="saisies">
      <div class="grid">
        <div class="card">
          <h2>Nouvelle saisie</h2>
          <div class="row">
            <input id="inputTitre" placeholder="Titre">
            <select id="inputMatiere"></select>
          </div>
          <div class="row">
            <input id="inputDate" type="date">
            <select id="inputJalons">
              <option value="0">J+0</option><option value="1">J+1</option><option value="3">J+3</option><option value="7">J+7</option><option value="15">J+15</option><option value="30">J+30</option>
            </select>
          </div>
          <textarea id="inputNotes" placeholder="Notes"></textarea>
          <div class="row">
            <button id="btnAdd">Ajouter</button>
            <button id="btnExport" class="secondary" type="button">Exporter (.json)</button>
            <input id="fileImport" type="file" accept=".json" style="display:none">
            <button id="btnImport" class="secondary" type="button">Importer (.json)</button>
          </div>
        </div>
        <div class="card">
          <h2>Liste</h2>
          <div class="list" id="listItems"></div>
        </div>
      </div>
    </section>

    <!-- PLANNING -->
    <section class="tab" id="planning">
      <div class="card">
        <h2>Planning Ã  5 jours</h2>
        <div id="planningList"></div>
      </div>
    </section>

    <!-- AGENDA -->
    <section class="tab" id="agenda">
      <div class="card">
        <h2>Agenda</h2>
        <table id="agendaTable">
          <thead><tr><th>Date</th><th>Titre</th><th>MatiÃ¨re</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- MATIERES -->
    <section class="tab" id="matieres">
      <div class="card">
        <h2>MatiÃ¨res</h2>
        <div class="row">
          <input id="inputNewMatiere" placeholder="Ajouter une matiÃ¨re">
          <button id="btnAddMatiere">Ajouter</button>
        </div>
        <div id="matieresList" class="list"></div>
      </div>
    </section>
  </main>

  <template id="tplItem">
    <div class="card">
      <div class="row">
        <input class="eTitre" placeholder="Titre">
        <select class="eMatiere"></select>
      </div>
      <div class="row">
        <input class="eDate" type="date">
        <select class="eJalons">
          <option value="0">J+0</option><option value="1">J+1</option><option value="3">J+3</option><option value="7">J+7</option><option value="15">J+15</option><option value="30">J+30</option>
        </select>
      </div>
      <textarea class="eNotes" placeholder="Notes"></textarea>
      <div class="row">
        <button class="primary eSave" type="button">Enregistrer</button>
        <button class="secondary eDup" type="button">Dupliquer</button>
        <button class="danger eDel" type="button">Supprimer</button>
      </div>
    </div>
  </template>

  <script>
    /* ========= REMPLACE ICI ========= */
    const SUPABASE_URL = "https://smxqtzbqachmzefyjpuj.supabase.co";       /* <-- remplace */
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNteHF0emJxYWNobXplZnlqcHVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTY5ODMsImV4cCI6MjA3MjM3Mjk4M30.F2X2j_YqSlvMwr8Pa9PzFt3p0c4LlrBCE95FkyFUwVc";                 /* <-- remplace */
    /* ================================= */
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const REDIRECT_URL = "https://planning-revisions.vercel.app"; /* redirection forcÃ©e */
  </script>

  <script>
    /* ===================== UTILITAIRES ===================== */
    const JALONS=[0,1,3,7,15,30], FR='fr-FR';
    const fmtDateLabel=d=>d.toLocaleDateString(FR,{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
    const toLocalDate=s=>new Date(`${s}T00:00:00`);
    const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x};
    const isoDate=d=>d.toISOString().slice(0,10);
    const todayIso=()=>isoDate(new Date());
    const escapeHtml=(str='')=>str.replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));

    /* ===================== STORE LOCAL ===================== */
    const store={
      get matieres(){return JSON.parse(localStorage.getItem('matieres_v3'))||['FranÃ§ais','Maths','Histoire-GÃ©o','SVT','Physique-Chimie','Langues','Arts','EMC','Techno','Enseignement SpÃ©cifique','EPS']},
      set matieres(v){localStorage.setItem('matieres_v3',JSON.stringify(v))},
      get items(){return JSON.parse(localStorage.getItem('items_v3'))||[]},
      set items(v){localStorage.setItem('items_v3',JSON.stringify(v))}
    };

    // Migration Ã©ventuelle depuis ancien stockage
    (()=>{ if(localStorage.getItem('matieres')){ store.matieres=[...new Set([...store.matieres, ...JSON.parse(localStorage.getItem('matieres')||'[]')])]; localStorage.removeItem('matieres'); } })();

    /* ===================== NAVIGATION ===================== */
    const tabs=[...document.querySelectorAll('.tab')];
    function showTab(id){ tabs.forEach(t=>t.classList.toggle('active',t.id===id)); document.querySelectorAll('nav a[data-tab]').forEach(a=>a.setAttribute('aria-current', a.dataset.tab===id?'page':null)); }
    document.querySelectorAll('nav a[data-tab]').forEach(a=>a.addEventListener('click',e=>{e.preventDefault();showTab(a.dataset.tab)}));

    /* ===================== MATIERES ===================== */
    const elMatSel=()=>[...document.querySelectorAll('select.eMatiere, #inputMatiere')];
    function renderMatieres(){ const opts=store.matieres.map(m=>`<option>${escapeHtml(m)}</option>`).join(''); elMatSel().forEach(s=>s.innerHTML=opts); }
    document.getElementById('btnAddMatiere').addEventListener('click',()=>{ const v=document.getElementById('inputNewMatiere').value.trim(); if(!v) return; store.matieres=[...store.matieres,v]; document.getElementById('inputNewMatiere').value=''; renderMatieres(); });

    /* ===================== ITEMS CRUD (LOCAL) ===================== */
    const list=document.getElementById('listItems');
    function row(it){
      const tpl=document.getElementById('tplItem').content.cloneNode(true);
      tpl.querySelector('.eTitre').value=it.titre||'';
      tpl.querySelector('.eMatiere').value=it.matiere||store.matieres[0];
      tpl.querySelector('.eDate').value=it.date||todayIso();
      tpl.querySelector('.eJalons').value=(it.jalon||0);
      tpl.querySelector('.eNotes').value=it.notes||'';
      tpl.querySelector('.eSave').addEventListener('click',()=>updateItem(it.id,{ titre:tpl.querySelector('.eTitre').value.trim(), matiere:tpl.querySelector('.eMatiere').value, date:tpl.querySelector('.eDate').value, jalon:+tpl.querySelector('.eJalons').value, notes:tpl.querySelector('.eNotes').value.trim() }));
      tpl.querySelector('.eDup').addEventListener('click',()=>addItem({ ...it, id:crypto.randomUUID(), titre:(it.titre||'')+' (copie)' }));
      tpl.querySelector('.eDel').addEventListener('click',()=>deleteItem(it.id));
      return tpl;
    }
    function renderItems(){ list.innerHTML=''; (store.items||[]).forEach(it=>list.appendChild(row(it))); }
    function addItem(obj){ const it={ id:obj.id||crypto.randomUUID(), titre:obj.titre||'', matiere:obj.matiere||store.matieres[0], date:obj.date||todayIso(), jalon:obj.jalon||0, notes:obj.notes||'' }; store.items=[...store.items, it]; renderItems(); renderPlanning(); renderAgenda(); }
    function updateItem(id,patch){ store.items=store.items.map(it=>it.id===id?{...it,...patch}:it); renderItems(); renderPlanning(); renderAgenda(); }
    function deleteItem(id){ store.items=store.items.filter(it=>it.id!==id); renderItems(); renderPlanning(); renderAgenda(); }

    /* ===================== EXPORT / IMPORT ===================== */
    document.getElementById('btnExport').addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify({ items:store.items, matieres:store.matieres },null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`revisions_${todayIso()}.json`; a.click(); URL.revokeObjectURL(a.href);
    });
    document.getElementById('btnImport').addEventListener('click',()=>document.getElementById('fileImport').click());
    document.getElementById('fileImport').addEventListener('change', (ev)=>{
      const file=ev.target.files?.[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{ try{
          const data=JSON.parse(reader.result);
          if(Array.isArray(data?.items)) store.items=data.items;
          if(Array.isArray(data?.matieres)) store.matieres=[...new Set([...store.matieres, ...data.matieres])];
          renderMatieres(); renderItems(); renderPlanning(); renderAgenda();
        }catch{ alert('Fichier invalide.'); }
      };
      reader.readAsText(file);
    });

    /* ===================== INITIALISATION ===================== */
    function refreshAll(){ renderItems(); renderPlanning(); renderAgenda(); renderMatieres(); }
    renderMatieres(); refreshAll();

    /* ===================== AUTH & SYNC SUPABASE ===================== */
    const btnSignIn=document.getElementById('btnSignIn');
    const btnConnect=document.getElementById('btnConnect');
    const btnLogout=document.getElementById('btnLogout');
    let mode='local'; // 'local' | 'cloud'

    function updateAuthUI({isAuthed, isConnected}){
      if(!isAuthed){
        btnSignIn.style.display='';
        btnConnect.style.display='none';
        btnLogout.style.display='none';
        return;
      }
      btnSignIn.style.display='none';
      if(isConnected){
        btnConnect.style.display='none';
        btnLogout.style.display='';
      }else{
        btnConnect.style.display='';
        btnLogout.style.display='none';
      }
    }

    // Sign in avec code (OTP 6 chiffres)
    btnSignIn?.addEventListener('click', async ()=>{
      const email=prompt("Entre ton email pour recevoir un code (6 chiffres) :");
      if(!email) return;
      const { error } = await window.sb.auth.signInWithOtp({ email, options:{ shouldCreateUser:true } });
      if(error) return alert("Erreur: " + error.message);
      const token = prompt("Code reÃ§u par email (6 chiffres) :");
      if(!token) return;
      const { error: e2 } = await window.sb.auth.verifyOtp({ email, token, type:'email' });
      if(e2) return alert("Erreur vÃ©rification code: " + e2.message);
      alert("Identification rÃ©ussie. Tu peux maintenant te connecter au cloud.");
      updateAuthUI({isAuthed:true, isConnected:false});
    });

    async function ensureProfile(user){
      try{ await window.sb.from('profiles').upsert({ id:user.id, email:user.email }).select().single(); }catch(e){ console.warn(e); }
    }

    async function maybeMigrateLocalToCloud(user){
      const { data:rows, error } = await window.sb.from('items_v3').select('id').limit(1);
      if(error){ console.error(error); return; }
      if(rows && rows.length) return;
      const localItems=store.items||[]; if(!localItems.length) return;
      const upserts=localItems.map(it=>({ id:it.id||crypto.randomUUID(), owner_id:user.id, data:it }));
      const { error:e2 } = await window.sb.from('items_v3').upsert(upserts);
      if(e2){ console.error(e2); return; }
      alert("Migration effectuÃ©e : tes donnÃ©es locales sont maintenant en ligne.");
    }

    async function loadFromCloud(user){
      const { data, error } = await window.sb.from('items_v3')
        .select('id,data,updated_at,created_at')
        .eq('owner_id',user.id)
        .order('created_at',{ascending:true});
      if(error){ console.error(error); return; }
      const items=(data||[]).map(r=>({ ...r.data, id:r.data.id||r.id }));
      store.items=items; mode='cloud'; refreshAll();
    }

    // Connexion cloud explicite
    btnConnect?.addEventListener('click', async ()=>{
      const { data:{ user } } = await window.sb.auth.getUser();
      if(!user) return alert("Identifie-toi d'abord.");
      await ensureProfile(user);
      await maybeMigrateLocalToCloud(user);
      await loadFromCloud(user);
      mode='cloud';
      updateAuthUI({isAuthed:true, isConnected:true});
      alert("ConnectÃ© au cloud.");
    });

    // DÃ©connexion (cloud + session)
    btnLogout?.addEventListener('click', async ()=>{
      mode='local';
      await window.sb.auth.signOut();
      updateAuthUI({isAuthed:false, isConnected:false});
      alert("DÃ©connectÃ©.");
    });

    // Suivi dâ€™Ã©tat
    window.sb.auth.onAuthStateChange(async (_ev, session)=>{
      const isAuthed = !!session?.user;
      const isConnected = isAuthed && mode==='cloud';
      updateAuthUI({isAuthed, isConnected});
    });

    /* ===================== PLAN / AGENDA ===================== */
    function renderPlanning(){
      const root=document.getElementById('planningList'); root.innerHTML='';
      const base=new Date(); base.setHours(0,0,0,0);
      for(let i=0;i<5;i++){
        const d=new Date(base); d.setDate(base.getDate()+i);
        const iso=isoDate(d);
        const items=(store.items||[]).filter(it=>it.date===iso);
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`<h3>${fmtDateLabel(d)}</h3>` + (items.length? items.map(it=>`<div class="pill"><strong>${escapeHtml(it.titre)}</strong> â€” ${escapeHtml(it.matiere)}</div>`).join('<br>') : `<div class="empty">Rien de prÃ©vu.</div>`);
        root.appendChild(card);
      }
    }

    function renderAgenda(){
      const tbody=document.querySelector('#agendaTable tbody'); tbody.innerHTML='';
      (store.items||[]).sort((a,b)=>a.date.localeCompare(b.date)).forEach(it=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${escapeHtml(it.date)}</td><td>${escapeHtml(it.titre)}</td><td>${escapeHtml(it.matiere)}</td>`;
        tbody.appendChild(tr);
      });
    }

    // EntrÃ©es
    document.getElementById('btnAdd').addEventListener('click',()=>{
      const titre=document.getElementById('inputTitre').value.trim();
      const matiere=document.getElementById('inputMatiere').value;
      const date=document.getElementById('inputDate').value || todayIso();
      const jalon=+document.getElementById('inputJalons').value;
      const notes=document.getElementById('inputNotes').value.trim();
      addItem({ titre, matiere, date, jalon, notes });
      document.getElementById('inputTitre').value='';
      document.getElementById('inputNotes').value='';
    });

    // Mise Ã  jour sÃ©lecteur matiÃ¨res initial
    (function initMatiereSelect(){ const sel=document.getElementById('inputMatiere'); sel.innerHTML=store.matieres.map(m=>`<option>${escapeHtml(m)}</option>`).join(''); })();

    // Export/Import dÃ©jÃ  cÃ¢blÃ©s plus haut

    /* ===================== CLOUD WRAPPERS ===================== */
    const _addItem=addItem, _updateItem=updateItem, _deleteItem=deleteItem;
    addItem=(obj)=>{ _addItem(obj); if(mode==='cloud') upsertCloud([obj]); };
    updateItem=(id,patch)=>{ _updateItem(id,patch); if(mode==='cloud'){ const it=store.items.find(i=>i.id===id); if(it) upsertCloud([it]); } };
    deleteItem=(id)=>{ const it=store.items.find(i=>i.id===id); _deleteItem(id); if(mode==='cloud'&&it) deleteCloud(id); };

    async function upsertCloud(items){
      const { data:{ user } } = await window.sb.auth.getUser();
      if(!user) return;
      const rows=items.map(i=>({ id:i.id||crypto.randomUUID(), owner_id:user.id, data:i, updated_at:new Date().toISOString() }));
      const { error } = await window.sb.from('items_v3').upsert(rows);
      if(error) console.error(error);
    }
    async function deleteCloud(id){
      const { error } = await window.sb.from('items_v3').delete().eq('id',id);
      if(error) console.error(error);
    }
  </script>
</body>
</html>
