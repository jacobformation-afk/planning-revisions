<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planning de RÃ©visions â€” cloud + realtime</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#a6b0c3; --text:#e9eef7; --primary:#4caf50; --accent:#2c3e50; --danger:#e74c3c;
      --dayA: rgba(255, 235, 59, 0.18);   /* jaune clair (amber) */
      --dayB: rgba(207, 216, 220, 0.16);  /* gris clair (blue-grey 200) */
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue";margin:0;color:var(--text);background:linear-gradient(180deg,#0b1220,#0d1424 35%,#0f1628)}
    header{position:sticky;top:0;z-index:20;background:rgba(11,18,32,.75);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    nav{display:flex;gap:.5rem;align-items:center;max-width:1100px;margin:0 auto;padding:.75rem 1rem}
    nav a, nav button{color:#cfe2ff;text-decoration:none;font-weight:700;padding:.55rem .8rem;border-radius:12px;border:1px solid #223352;background:#1b2942;cursor:pointer}
    nav a[aria-current="page"],nav a:hover,nav button:hover{background:#223352}
    main{max-width:1100px;margin:0 auto;padding:1rem}
    .tab{display:none}.tab.active{display:block}
    .grid{display:grid;gap:1rem}
    .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;padding:1rem;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h2{margin:.25rem 0 1rem}
    iframe{border:0;width:100%;border-radius:12px}
    input,select,textarea,button{width:100%;padding:.7rem .8rem;border-radius:12px;border:1px solid #25364f;background:#0f172a;color:var(--text)}
    textarea{min-height:90px}
    button{cursor:pointer;background:#1b8f3f;border:1px solid #1e9a45;font-weight:700}
    button.secondary{background:#1b2942;border-color:#223352}
    button.danger{background:#7a1f1b;border-color:#8a241f}
    .row{display:flex;gap:.5rem;flex-wrap:wrap}.row>*{flex:1 1 220px}
    .list{max-height:420px;overflow:auto}
    .pill{display:inline-flex;align-items:center;gap:.5ch;background:#102038;border:1px solid #223352;border-radius:999px;padding:.35rem .6rem}
    .muted{color:#a6b0c3}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid #223352;padding:.5rem;text-align:left;vertical-align:top}
    th{background:#0f172a}
    .badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;border:1px solid #223352;background:#0f172a;font-size:.85rem}

    /* Alternance de couleurs par journÃ©e dans l'Agenda */
    tbody tr.dayA td{ background: var(--dayA); }
    tbody tr.dayB td{ background: var(--dayB); }

    /* Highlight pour "Aujourd'hui" */
    tr.flash td{ animation: flashBg 1.5s ease; }
    @keyframes flashBg{ 0%{background:#1f2937;} 100%{background:transparent;} }
  </style>

  <!-- Supabase (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ========= REMPLACE ICI ========= */
    const SUPABASE_URL = "https://smxqtzbqachmzefyjpuj.supabase.co";       /* <-- remplace */
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNteHF0emJxYWNobXplZnlqcHVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTY5ODMsImV4cCI6MjA3MjM3Mjk4M30.F2X2j_YqSlvMwr8Pa9PzFt3p0c4LlrBCE95FkyFUwVc";                 /* <-- remplace */
    /* ================================= */
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* NOTE important (cÃ´tÃ© projet Supabase, pas dans ce fichier) :
       - Activer Realtime sur la table public.items_v3
       - Avoir une policy RLS SELECT :  USING (owner_id = auth.uid())
       - S'assurer que la table est dans la publication supabase_realtime
       SQL utile :
         create policy "can select own items" on public.items_v3 for select using (owner_id = auth.uid());
         alter publication supabase_realtime add table public.items_v3;
    */
  </script>
</head>
<body>
  <header>
    <nav>
      <strong>ðŸ“š Planning de RÃ©visions</strong>
      <a href="#" data-tab="accueil" aria-current="page">Accueil</a>
      <a href="#" data-tab="saisies">Saisies du jour</a>
      <a href="#" data-tab="planning">Planning Ã  5 jours</a>
      <a href="#" data-tab="agenda">Agenda</a>
      <a href="#" data-tab="matieres">MatiÃ¨res</a>
      <div style="margin-left:auto; display:flex; gap:.5rem">
        <button id="btnSignIn" class="secondary" type="button">S'identifier</button>
        <button id="btnConnect" class="secondary" type="button" style="display:none">Connecter au cloud</button>
        <button id="btnLogout" class="secondary" type="button" style="display:none">Se dÃ©connecter</button>
      </div>
    </nav>
  </header>

  <main>
    <!-- ACCUEIL -->
    <section class="tab active" id="accueil">
      <div class="grid" style="grid-template-columns:2fr 1fr">
        <div class="card">
          <h2>Bonjour</h2>
          <p class="muted">Bienvenue â€” musique du jour.</p>
          <h3>ðŸŽµ Musique</h3>
          <iframe title="Lecteur Deezer" scrolling="no" allowtransparency="true"
            src="https://www.deezer.com/plugins/player?format=classic&autoplay=false&playlist=true&width=700&height=350&color=007FEB&layout=dark&size=medium&type=tracks&id=3135556&app_id=1"
            height="100"></iframe>
        </div>
        <div class="card">
          <h2>Synchronisation</h2>
          <p><span class="badge">Local</span> â†’ hors-ligne. <span class="badge">Cloud</span> â†’ sauvegarde & multi-appareils.</p>
          <ul>
            <li><strong>Sâ€™identifier</strong> : email (magic link).</li>
            <li><strong>Connecter au cloud</strong> : charge tes donnÃ©es en ligne (et migre si cloud vide).</li>
            <li><strong>Se dÃ©connecter</strong> : revient en local + sign out.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- SAISIES -->
    <section class="tab" id="saisies">
      <div class="card">
        <h2>Saisies du jour</h2>
        <div class="row">
          <select id="typeSelect" aria-label="Type">
            <option value="revision">RÃ©vision</option>
            <option value="devoir_rendre">Devoir Ã  rendre</option>
            <option value="devoir_preparer">Devoir Ã  prÃ©parer</option>
            <option value="lecture">Lecture</option>
          </select>
          <select id="matiereSelect" aria-label="MatiÃ¨re"></select>
          <input id="titreInput" placeholder="Titre (ex. DM fonctions / Lecture Candide)" />
        </div>

        <div class="row">
          <textarea id="descriptionInput" placeholder="Description / consignes / notes..."></textarea>
        </div>

        <!-- SpÃ©cifiques par type -->
        <div id="formRevision" class="row">
          <input id="dateRevision" type="date" aria-label="Date de rÃ©vision" />
          <div class="pill">Jalons: J+0, J+1, J+3, J+7, J+15, J+30</div>
        </div>

        <div id="formRendre" class="row hidden">
          <input id="echeanceRendre" type="date" aria-label="Ã‰chÃ©ance (ex. date de rendu)" />
          <input id="dateDevoirRendre" type="date" aria-label="Date du devoir" />
          <select id="prioriteRendre">
            <option value="1">PrioritÃ© normale</option>
            <option value="2">Haute</option>
            <option value="0">Basse</option>
          </select>
          <input id="progressRendre" type="number" min="0" max="100" value="0" aria-label="Progression (%)" />
        </div>

        <div id="formPreparer" class="row hidden">
          <input id="echeancePreparer" type="date" aria-label="Ã‰chÃ©ance (fin de prÃ©paration)" />
          <input id="dateDevoirPreparer" type="date" aria-label="Date du devoir" />
          <input id="dureeTotale" type="number" min="0" step="15" placeholder="DurÃ©e totale (min)" />
          <input id="dureeSession" type="number" min="0" step="5" placeholder="DurÃ©e par session (min)" />
        </div>

        <div id="formLecture" class="row hidden">
          <input id="ouvrageTitre" placeholder="Titre de lâ€™ouvrage" />
          <input id="ouvrageAuteur" placeholder="Auteur" />
          <input id="chapitresTotal" type="number" min="1" step="1" placeholder="Nombre de chapitres" />
          <input id="echeanceLecture" type="date" aria-label="Ã‰chÃ©ance de lecture" />
        </div>

        <div class="row">
          <button id="btnAjouter" type="button">Ajouter</button>
          <button id="btnExport" class="secondary" type="button">Exporter (.json)</button>
          <input id="fileImport" type="file" accept=".json" style="display:none">
          <button id="btnImport" class="secondary" type="button">Importer (.json)</button>
        </div>
      </div>

      <div class="card">
        <h2>Liste</h2>
        <div id="listeItems" class="list"></div>
      </div>
    </section>

    <!-- PLANNING -->
    <section class="tab" id="planning">
      <div class="card">
        <h2>Planning Ã  5 jours</h2>
        <table id="planningTable">
          <thead><tr id="planningHeader"></tr></thead>
          <tbody><tr id="planningRow"></tr></tbody>
        </table>
      </div>
    </section>

    <!-- AGENDA -->
    <section class="tab" id="agenda">
      <div class="card">
        <h2>Agenda</h2>
        <div class="row">
          <input id="rechercheAgenda" placeholder="Rechercher dans lâ€™agenda..." />
          <button id="btnGoToday" type="button" class="secondary" style="max-width:180px">Aujourdâ€™hui</button>
        </div>
        <table id="agendaTable">
          <thead><tr><th>Date</th><th>Titre</th><th>MatiÃ¨re</th><th>DÃ©tails</th><th>%</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- MATIERES -->
    <section class="tab" id="matieres">
      <div class="card">
        <h2>MatiÃ¨res</h2>
        <div class="row">
          <input id="nouvelleMatiere" placeholder="Nouvelle matiÃ¨re" type="text" />
          <button id="btnAjouterMatiere" type="button">Ajouter</button>
        </div>
        <ul id="listeMatieres" class="list"></ul>
      </div>
    </section>
  </main>

  <!-- Template item -->
  <template id="tplItem">
    <div class="card">
      <div class="row">
        <select class="eType">
          <option value="revision">RÃ©vision</option>
          <option value="devoir_rendre">Devoir Ã  rendre</option>
          <option value="devoir_preparer">Devoir Ã  prÃ©parer</option>
          <option value="lecture">Lecture</option>
        </select>
        <select class="eMatiere"></select>
      </div>
      <div class="row">
        <input class="eTitre" placeholder="Titre">
        <input class="eDate" type="date" />
      </div>
      <textarea class="eDescription" placeholder="Description / notes"></textarea>
      <div class="row">
        <button class="primary eSave" type="button">Enregistrer</button>
        <button class="secondary eDup" type="button">Dupliquer</button>
        <button data-pluschap class="secondary hidden" type="button">+1 chapitre lu</button>
        <button data-delete class="danger" type="button">Supprimer</button>
      </div>
    </div>
  </template>

  <script>
    /* ===================== UTILITAIRES ===================== */
    const JALONS=[0,1,3,7,15,30], FR='fr-FR';
    const fmtDateLabel=d=>d.toLocaleDateString(FR,{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
    const toLocalDate=s=>new Date(`${s}T00:00:00`);
    const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x};
    const isoDate=d=>d.toISOString().slice(0,10);
    const todayIso=()=>isoDate(new Date());
    const esc=(str='')=>String(str).replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));

    /* ===================== STORE LOCAL ===================== */
    const store={
      get matieres(){return JSON.parse(localStorage.getItem('matieres_v3'))||['FranÃ§ais','Maths','Histoire-GÃ©o','SVT','Physique-Chimie','Langues','Arts','EMC','Techno','Enseignement SpÃ©cifique','EPS']},
      set matieres(v){localStorage.setItem('matieres_v3',JSON.stringify(v))},
      get items(){return JSON.parse(localStorage.getItem('items_v3'))||[]},
      set items(v){localStorage.setItem('items_v3',JSON.stringify(v))}
    };

    /* ===================== NAVIGATION ===================== */
    const tabs=[...document.querySelectorAll('.tab')];
    function showTab(id){ tabs.forEach(t=>t.classList.toggle('active',t.id===id)); document.querySelectorAll('nav a[data-tab]').forEach(a=>a.setAttribute('aria-current', a.dataset.tab===id?'page':null)); }
    document.querySelectorAll('nav a[data-tab]').forEach(a=>a.addEventListener('click',e=>{e.preventDefault();showTab(a.dataset.tab)}));

    /* ===================== MATIERES ===================== */
    function renderMatieres(){
      const ul=document.getElementById('listeMatieres'); ul.innerHTML='';
      store.matieres.forEach(m=>{ const li=document.createElement('li'); li.textContent=m; ul.appendChild(li); });
      const opts=store.matieres.map(m=>`<option>${esc(m)}</option>`).join('');
      document.getElementById('matiereSelect').innerHTML=opts;
      document.querySelectorAll('.eMatiere').forEach(s=>s.innerHTML=opts);
    }
    document.getElementById('btnAjouterMatiere').addEventListener('click',()=>{
      const v=document.getElementById('nouvelleMatiere').value.trim(); if(!v) return;
      if(!store.matieres.includes(v)) store.matieres=[...store.matieres,v];
      document.getElementById('nouvelleMatiere').value=''; renderMatieres();
    });

    /* ===================== ITEMS CRUD (LOCAL + auto-push si identifiÃ©) ===================== */
    const els={
      typeSelect:document.getElementById('typeSelect'),
      matiereSelect:document.getElementById('matiereSelect'),
      titreInput:document.getElementById('titreInput'),
      descriptionInput:document.getElementById('descriptionInput'),
      dateRevision:document.getElementById('dateRevision'),
      echeanceRendre:document.getElementById('echeanceRendre'),
      dateDevoirRendre:document.getElementById('dateDevoirRendre'),
      prioriteRendre:document.getElementById('prioriteRendre'),
      progressRendre:document.getElementById('progressRendre'),
      echeancePreparer:document.getElementById('echeancePreparer'),
      dateDevoirPreparer:document.getElementById('dateDevoirPreparer'),
      dureeTotale:document.getElementById('dureeTotale'),
      dureeSession:document.getElementById('dureeSession'),
      ouvrageTitre:document.getElementById('ouvrageTitre'),
      ouvrageAuteur:document.getElementById('ouvrageAuteur'),
      chapitresTotal:document.getElementById('chapitresTotal'),
      echeanceLecture:document.getElementById('echeanceLecture'),
      listeItems:document.getElementById('listeItems'),
      planningHeader:document.getElementById('planningHeader'),
      planningRow:document.getElementById('planningRow'),
      agendaTable:document.querySelector('#agendaTable tbody'),
      rechercheAgenda:document.getElementById('rechercheAgenda'),
      btnGoToday:document.getElementById('btnGoToday')
    };

    // --- Afficher/masquer les blocs spÃ©cifiques + prÃ©remplir la date si vide ---
    document.getElementById('typeSelect').addEventListener('change',(e)=>{
      const t=e.target.value;
      document.getElementById('formRevision').classList.toggle('hidden', t!=='revision');
      document.getElementById('formRendre').classList.toggle('hidden', t!=='devoir_rendre');
      document.getElementById('formPreparer').classList.toggle('hidden', t!=='devoir_preparer');
      document.getElementById('formLecture').classList.toggle('hidden', t!=='lecture');

      if(t==='revision' && !els.dateRevision.value) els.dateRevision.value = todayIso();
      if(t==='devoir_rendre'){
        if(!els.echeanceRendre.value) els.echeanceRendre.value = todayIso();
        if(!els.dateDevoirRendre.value) els.dateDevoirRendre.value = els.echeanceRendre.value || todayIso();
      }
      if(t==='devoir_preparer'){
        if(!els.echeancePreparer.value) els.echeancePreparer.value = todayIso();
        if(!els.dateDevoirPreparer.value) els.dateDevoirPreparer.value = els.echeancePreparer.value || todayIso();
      }
      if(t==='lecture'){
        if(!els.echeanceLecture.value) els.echeanceLecture.value = todayIso();
      }
    });

    function row(it){
      const tpl=document.getElementById('tplItem').content.cloneNode(true);
      const eType=tpl.querySelector('.eType'); eType.value=it.type||'revision';
      const eMat=tpl.querySelector('.eMatiere'); eMat.innerHTML=store.matieres.map(m=>`<option>${esc(m)}</option>`).join(''); eMat.value=it.matiere||store.matieres[0];
      tpl.querySelector('.eTitre').value=it.titre||'';
      tpl.querySelector('.eDate').value=it.baseDate||it.echeance||todayIso();
      tpl.querySelector('.eDescription').value=it.description||'';
      const plusChapBtn=tpl.querySelector('[data-pluschap]');
      if(it.type==='lecture') plusChapBtn.classList.remove('hidden');
      plusChapBtn?.addEventListener('click',()=>{ it.lus = Number(it.lus||0)+1; updateItem(it.id,{ lus: it.lus }); });
      tpl.querySelector('.eSave').addEventListener('click',()=>{
        const patch={ type:eType.value, matiere:eMat.value,
          titre: tpl.querySelector('.eTitre').value.trim(),
          description: tpl.querySelector('.eDescription').value.trim()
        };
        if(patch.type==='revision') patch.baseDate=tpl.querySelector('.eDate').value || todayIso();
        if(patch.type==='devoir_rendre') patch.echeance=tpl.querySelector('.eDate').value || todayIso();
        if(patch.type==='devoir_preparer') patch.echeance=tpl.querySelector('.eDate').value || todayIso();
        if(patch.type==='lecture') patch.echeance=tpl.querySelector('.eDate').value || todayIso();
        updateItem(it.id, patch);
      });
      tpl.querySelector('[data-delete]').addEventListener('click',()=>deleteItem(it.id));
      return tpl;
    }

    function renderItems(){ els.listeItems.innerHTML=''; (store.items||[]).forEach(it=>els.listeItems.appendChild(row(it))); }

    async function isAuthed(){
      try{ const { data:{ user } } = await window.sb.auth.getUser(); return !!user; }catch{ return false; }
    }

    function addItem(){
      const type=els.typeSelect.value;
      const matiere=els.matiereSelect.value || store.matieres[0];
      const titre=els.titreInput.value.trim();
      const description=els.descriptionInput.value.trim();
      let payload={id:crypto.randomUUID(),type,matiere,titre,description,dateCreation:Date.now(),etat:'a_faire'};

      if(type==='revision'){
        const baseDate=els.dateRevision.value || todayIso();
        payload={...payload,baseDate,jalons:[...JALONS]};
      }
      if(type==='devoir_rendre'){
        const echeance=els.echeanceRendre.value || todayIso();
        const dateDevoir=els.dateDevoirRendre.value || echeance;
        payload={...payload,echeance,dateDevoir,priorite:Number(els.prioriteRendre.value||1),progress:Number(els.progressRendre.value||0)};
      }
      if(type==='devoir_preparer'){
        const echeance=els.echeancePreparer.value || todayIso();
        const dateDevoir=els.dateDevoirPreparer.value || echeance;
        const dureeTotale=Number(els.dureeTotale.value||0); if(!dureeTotale) return alert('Indique la durÃ©e totale estimÃ©e.');
        const dureeSession=Number(els.dureeSession.value||0) || 25;
        const sessions=[]; let cumul=0; let cursor=toLocalDate(todayIso());
        while(cumul<dureeTotale){
          sessions.push({date:isoDate(cursor),duree:Math.min(dureeSession,dureeTotale-cumul),fait:false});
          cursor=addDays(cursor,1); cumul+=dureeSession;
        }
        payload={...payload,echeance,dateDevoir,dureeTotale,dureeSession,sessions,progress:0};
      }
      if(type==='lecture'){
        const echeance = els.echeanceLecture.value || todayIso(); // nouvelle Ã©chÃ©ance lecture
        const chapitres=Number(els.chapitresTotal.value||0); if(!chapitres) return alert('Indique le nombre de chapitres.');
        const ouvrage={titre:els.ouvrageTitre.value.trim(),auteur:els.ouvrageAuteur.value.trim(),chapitres};

        // RÃ©partition uniforme de la lecture entre aujourdâ€™hui (date dâ€™entrÃ©e) et lâ€™Ã©chÃ©ance
        const start = toLocalDate(todayIso());
        const end = toLocalDate(echeance);
        let days = Math.floor((end - start)/(1000*60*60*24)) + 1;
        if (days < 1) days = 1;
        const perDay = Math.ceil(chapitres / days);
        const repartition=[];
        let chapter = 1;
        let cursor = new Date(start);
        for (let d=0; d<days && chapter<=chapitres; d++){
          const from = chapter;
          const to = Math.min(chapitres, chapter + perDay - 1);
          repartition.push({ date: isoDate(cursor), chapitres: from===to ? `Chapitre ${from}` : `Chapitres ${from}-${to}` });
          chapter = to + 1;
          cursor = addDays(cursor,1);
        }

        payload={...payload,echeance,ouvrage,repartition,lus:0};
      }

      store.items=[...store.items, payload];
      els.titreInput.value=''; els.descriptionInput.value='';
      renderItems(); renderPlanning(); renderAgenda();

      // Auto-push si identifiÃ©
      isAuthed().then(ok=>{ if(ok) upsertCloud([payload]); });
    }

    function updateItem(id,patch){
      store.items=store.items.map(it=>it.id===id?{...it,...patch}:it);
      renderItems(); renderPlanning(); renderAgenda();
      // Auto-push si identifiÃ©
      const it=store.items.find(i=>i.id===id);
      isAuthed().then(ok=>{ if(ok && it) upsertCloud([it]); });
    }

    function deleteItem(id){
      const it = store.items.find(i=>i.id===id);
      store.items=store.items.filter(i=>i.id!==id);
      renderItems(); renderPlanning(); renderAgenda();
      // Auto-push si identifiÃ©
      isAuthed().then(ok=>{ if(ok && it) deleteCloud(id); });
    }

    document.getElementById('btnAjouter').addEventListener('click',addItem);

    /* ===================== EXPORT / IMPORT ===================== */
    document.getElementById('btnExport').addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify({ items:store.items, matieres:store.matieres },null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`revisions_${todayIso()}.json`; a.click(); URL.revokeObjectURL(a.href);
    });
    document.getElementById('btnImport').addEventListener('click',()=>document.getElementById('fileImport').click());
    document.getElementById('fileImport').addEventListener('change', (ev)=>{
      const file=ev.target.files?.[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{ try{
          const data=JSON.parse(reader.result);
          if(Array.isArray(data?.items)) store.items=data.items;
          if(Array.isArray(data?.matieres)) store.matieres=[...new Set([...store.matieres, ...data.matieres])];
          renderMatieres(); renderItems(); renderPlanning(); renderAgenda();
        }catch{ alert('Fichier invalide.'); }
      };
      reader.readAsText(file);
    });

    /* ===================== INITIALISATION ===================== */
    function refreshAll(){ renderMatieres(); renderItems(); renderPlanning(); renderAgenda(); }
    refreshAll();

    /* ===================== AGENDA / PLANNING ===================== */
    function percentFor(it){
      if(it.type==='lecture'){ const tot=Number(it.ouvrage?.chapitres||0); return !tot?0:Math.round(100*(Number(it.lus||0)/tot)); }
      if(it.type==='devoir_preparer'){ const tot=Number(it.dureeTotale||0); const fait=(it.sessions||[]).filter(s=>s.fait).reduce((a,b)=>a+b.duree,0); return !tot?0:Math.round(100*fait/tot); }
      return Number(it.progress||0);
    }

    function addReminderEntriesByDate(map, dateStr, titre, matiere){
      if(!dateStr) return;
      const dEvent = toLocalDate(dateStr);
      for(let k=5;k>=1;k--){
        const d = isoDate(addDays(dEvent, -k));
        (map[d] ||= []).push({type:'rappel', matiere, titre, desc:`Rappel J-${k} avant devoir`, prog:''});
      }
    }

    function renderPlanning(){
      els.planningHeader.innerHTML=''; els.planningRow.innerHTML='';
      const base=new Date(); base.setHours(0,0,0,0);
      const dates=[];
      for(let i=0;i<5;i++){
        const d=new Date(base); d.setDate(base.getDate()+i);
        dates.push(isoDate(d));
        const th=document.createElement('th'); th.textContent=fmtDateLabel(d);
        els.planningHeader.appendChild(th);
        const td=document.createElement('td'); td.dataset.date=isoDate(d);
        els.planningRow.appendChild(td);
      }

      const itemsByDate={};
      // RÃ©visions
      store.items.filter(i=>i.type==='revision').forEach(r=>{
        const base=toLocalDate(r.baseDate);
        (r.jalons||[]).forEach((j,idx)=>{
          const d=isoDate(addDays(base,j));
          (itemsByDate[d] ||= []).push({type:'revision', matiere:r.matiere, titre:r.titre, desc:`RÃ©vision J+${j}`, prog:Math.round(((idx+1)/(r.jalons.length||1))*100)});
        });
      });
      // Devoir Ã  prÃ©parer
      store.items.filter(i=>i.type==='devoir_preparer').forEach(p=>{
        (p.sessions||[]).forEach(s=>{
          (itemsByDate[s.date] ||= []).push({type:'devoir_preparer', matiere:p.matiere, titre:p.titre, desc:`Session ${s.duree} min`, prog: s.fait?100:0});
        });
        (itemsByDate[p.echeance] ||= []).push({type:'devoir_preparer', matiere:p.matiere, titre:p.titre, desc:'Ã‰chÃ©ance', prog: percentFor(p)});
        addReminderEntriesByDate(itemsByDate, p.dateDevoir, p.titre, p.matiere);
      });
      // Devoir Ã  rendre
      store.items.filter(i=>i.type==='devoir_rendre').forEach(dv=>{
        (itemsByDate[dv.echeance] ||= []).push({type:'devoir_rendre', matiere:dv.matiere, titre:dv.titre, desc:'Ã€ rendre', prog:Number(dv.progress||0)});
        addReminderEntriesByDate(itemsByDate, dv.dateDevoir, dv.titre, dv.matiere);
      });
      // Lecture
      store.items.filter(i=>i.type==='lecture').forEach(le=>{
        (le.repartition||[]).forEach(part=>{
          (itemsByDate[part.date] ||= []).push({type:'lecture', matiere:le.matiere, titre:le.ouvrage?.titre||le.titre, desc:`${part.chapitres}`, prog: percentFor(le)});
        });
      });

      dates.forEach(d=>{
        const td = els.planningRow.querySelector(`td[data-date="${d}"]`);
        const items = itemsByDate[d]||[];
        if(!items.length){ td.innerHTML = `<div class="muted">Rien de prÃ©vu.</div>`; return; }
        td.innerHTML = items.map(it=>`<div class="pill"><strong>${esc(it.titre)}</strong> â€” ${esc(it.matiere)} <span class="muted">Â· ${esc(it.desc||'')}</span> ${it.prog!==''?`<span class="muted">Â· ${it.prog}%</span>`:''}</div>`).join('<br>');
      });
    }

    function renderAgenda(){
      const tbody=els.agendaTable; tbody.innerHTML='';
      const byDate={};
      // RÃ©visions
      store.items.filter(i=>i.type==='revision').forEach(r=>{
        const base=toLocalDate(r.baseDate);
        (r.jalons||[]).forEach((j,idx)=>{
          const d=isoDate(addDays(base,j));
          (byDate[d] ||= []).push({type:'revision', matiere:r.matiere, titre:r.titre, desc:`RÃ©vision J+${j}`, prog:Math.round(((idx+1)/(r.jalons.length||1))*100)});
        });
      });
      // Devoir Ã  prÃ©parer
      store.items.filter(i=>i.type==='devoir_preparer').forEach(p=>{
        (p.sessions||[]).forEach(s=>{ (byDate[s.date] ||= []).push({type:'devoir_preparer', matiere:p.matiere, titre:p.titre, desc:`Session ${s.duree} min`, prog: s.fait?100:0}); });
        (byDate[p.echeance] ||= []).push({type:'devoir_preparer', matiere:p.matiere, titre:p.titre, desc:'Ã‰chÃ©ance', prog: percentFor(p)});
        addReminderEntriesByDate(byDate, p.dateDevoir, p.titre, p.matiere);
      });
      // Devoir Ã  rendre
      store.items.filter(i=>i.type==='devoir_rendre').forEach(dv=>{
        (byDate[dv.echeance] ||= []).push({type:'devoir_rendre', matiere:dv.matiere, titre:dv.titre, desc:'Ã€ rendre', prog:Number(dv.progress||0)});
        addReminderEntriesByDate(byDate, dv.dateDevoir, dv.titre, dv.matiere);
      });
      // Lecture
      store.items.filter(i=>i.type==='lecture').forEach(le=>{
        (le.repartition||[]).forEach(part=>{ (byDate[part.date] ||= []).push({type:'lecture', matiere:le.matiere, titre:le.ouvrage?.titre||le.titre, desc:`${part.chapitres}`, prog: percentFor(le)}); });
      });

      const q=els.rechercheAgenda.value.trim().toLowerCase();
      const rows=[];
      let groupIndex=0;
      Object.keys(byDate).sort().forEach(date=>{
        const groupClass = (groupIndex % 2 === 0) ? 'dayA' : 'dayB';
        let pushed=false;
        (byDate[date]||[]).forEach(it=>{
          const line=[date,it.titre,it.matiere,it.desc, String(it.prog)];
          if(!q || line.join(' ').toLowerCase().includes(q)){
            rows.push(`<tr class="${groupClass}"><td>${esc(date)}</td><td>${esc(it.titre)}</td><td>${esc(it.matiere)}</td><td>${esc(it.desc||'')}</td><td>${it.prog!==''?esc(it.prog)+'%':''}</td></tr>`);
            pushed=true;
          }
        });
        if(pushed) groupIndex++; // alterner uniquement si au moins une ligne affichÃ©e pour cette date
      });
      tbody.innerHTML=rows.join('');
    }
    els.rechercheAgenda.addEventListener('input', renderAgenda);

    // Bouton "Aujourdâ€™hui" â€” scroll + highlight
    function goToday(){
      const tbody = els.agendaTable;
      const rows = Array.from(tbody.querySelectorAll('tr'));
      if(!rows.length) return;

      const today = todayIso();
      let target = rows.find(r => (r.children[0]?.textContent||'').trim() === today);
      if(!target){
        target = rows.find(r => (r.children[0]?.textContent||'') >= today) || rows[rows.length-1];
      }
      if(target){
        rows.forEach(r=>r.classList.remove('flash'));
        target.scrollIntoView({behavior:'smooth', block:'center'});
        target.classList.add('flash');
        setTimeout(()=>target.classList.remove('flash'), 1600);
      }
    }
    els.btnGoToday.addEventListener('click', goToday);

    /* ===================== AUTH & SYNC SUPABASE (magic link ONLY + Realtime) ===================== */
    const btnSignIn=document.getElementById('btnSignIn');
    const btnConnect=document.getElementById('btnConnect');
    const btnLogout=document.getElementById('btnLogout');
    let mode='local'; // 'local' | 'cloud'

    function updateAuthUI({isAuthed, isConnected}){
      if(!isAuthed){ btnSignIn.style.display=''; btnConnect.style.display='none'; btnLogout.style.display='none'; return; }
      btnSignIn.style.display='none';
      if(isConnected){ btnConnect.style.display='none'; btnLogout.style.display=''; }
      else { btnConnect.style.display=''; btnLogout.style.display='none'; }
    }
    window.updateAuthUI = updateAuthUI;

    // --- Realtime helpers ---
    async function enableRealtime(user){
      if(!user) return;
      if(window.itemsChannel){ try{ await window.sb.removeChannel(window.itemsChannel); }catch{} }
      window.itemsChannel = window.sb
        .channel('realtime:public:items_v3')
        .on('postgres_changes',{
          event:'*', schema:'public', table:'items_v3',
          filter:`owner_id=eq.${user.id}`
        }, (payload)=>{
          const ev = payload.eventType;
          if(ev==='INSERT' || ev==='UPDATE'){
            const it = payload.new?.data; if(!it?.id) return;
            const exists = (store.items||[]).some(x=>x.id===it.id);
            store.items = exists ? store.items.map(x=>x.id===it.id?it:x) : [...store.items, it];
          }else if(ev==='DELETE'){
            const id = payload.old?.id; if(!id) return;
            store.items = (store.items||[]).filter(x=>x.id!==id);
          }
          renderItems(); renderPlanning(); renderAgenda();
        })
        .subscribe();
    }
    async function disableRealtime(){
      if(window.itemsChannel){ try{ await window.sb.removeChannel(window.itemsChannel); }catch{} window.itemsChannel=null; }
    }

    // Magic link: envoi de l'email avec redirection explicite vers CETTE page
    btnSignIn?.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      if (!window.sb?.auth) { alert("Supabase non initialisÃ©."); return; }
      const email = prompt("Entre ton email :"); if (!email) return;

      const redirectTo = `${location.origin}${location.pathname}`;
      const { error } = await window.sb.auth.signInWithOtp({
        email,
        options: { shouldCreateUser: true, emailRedirectTo: redirectTo }
      });
      if (error) { alert("Erreur: " + error.message); return; }
      alert("Un email vient d'Ãªtre envoyÃ©. Clique le lien pour revenir ici et te connecter.");
    });

    // Retour du magic link: session crÃ©Ã©e â†’ UI + realtime + nettoyage URL
    window.addEventListener('load', async () => {
      try {
        const hash = new URLSearchParams(location.hash.slice(1));
        if (hash.get('access_token')) {
          const { data:{ user } } = await window.sb.auth.getUser();
          window.updateAuthUI?.({ isAuthed: !!user, isConnected: false });
          btnConnect?.style.setProperty('display','');
          document.getElementById('btnSignIn')?.style.setProperty('display','none');
          await enableRealtime(user);
          history.replaceState({}, document.title, location.pathname);
        }
      } catch (_) {}
    });

    async function ensureProfile(user){
      try{ await window.sb.from('profiles').upsert({ id:user.id, email:user.email }).select().single(); }catch(e){ console.warn(e); }
    }
    async function maybeMigrateLocalToCloud(user){
      const { data:rows, error } = await window.sb.from('items_v3').select('id').limit(1);
      if(error){ console.error(error); return; }
      if(rows && rows.length) return;
      const localItems=store.items||[]; if(!localItems.length) return;
      const upserts=localItems.map(it=>({ id:it.id||crypto.randomUUID(), owner_id:user.id, data:it }));
      const { error:e2 } = await window.sb.from('items_v3').upsert(upserts);
      if(e2){ console.error(e2); return; }
      alert("Migration effectuÃ©e : tes donnÃ©es locales sont maintenant en ligne.");
    }
    async function loadFromCloud(user){
      const { data, error } = await window.sb.from('items_v3')
        .select('id,data,updated_at,created_at')
        .eq('owner_id',user.id)
        .order('created_at',{ascending:true});
      if(error){ console.error(error); return; }
      const items=(data||[]).map(r=>({ ...r.data, id:r.data.id||r.id }));
      store.items=items; mode='cloud'; refreshAll();
    }
    btnConnect?.addEventListener('click', async ()=>{
      const { data:{ user } } = await window.sb.auth.getUser();
      if(!user) return alert("Identifie-toi d'abord (clique le lien dans l'email).");
      await ensureProfile(user);
      await maybeMigrateLocalToCloud(user);
      await loadFromCloud(user);
      await enableRealtime(user);
      mode='cloud';
      updateAuthUI({isAuthed:true, isConnected:true});
      alert("ConnectÃ© au cloud.");
    });
    btnLogout?.addEventListener('click', async ()=>{
      mode='local';
      await disableRealtime();
      await window.sb.auth.signOut();
      updateAuthUI({isAuthed:false, isConnected:false});
      alert("DÃ©connectÃ©.");
    });
    window.sb.auth.onAuthStateChange(async (_ev, session)=>{
      const user = session?.user || null;
      const isAuthed = !!user;
      const isConnected = isAuthed && mode==='cloud';
      updateAuthUI({isAuthed, isConnected});
      if(isAuthed){ await enableRealtime(user); } else { await disableRealtime(); }
    });

    /* ===================== Cloud helpers ===================== */
    async function upsertCloud(items){
      const { data:{ user } } = await window.sb.auth.getUser();
      if(!user) return;
      const rows=items.map(i=>({ id:i.id||crypto.randomUUID(), owner_id:user.id, data:i, updated_at:new Date().toISOString() }));
      const { error } = await window.sb.from('items_v3').upsert(rows);
      if(error) console.error(error);
    }
    async function deleteCloud(id){
      const { error } = await window.sb.from('items_v3').delete().eq('id',id);
      if(error) console.error(error);
    }
  </script>
</body>
</html>
