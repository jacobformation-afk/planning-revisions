<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planning de R√©visions ‚Äî v3 (cloud ready)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#a6b0c3; --text:#e9eef7; --primary:#4caf50; --accent:#2c3e50; --danger:#e74c3c;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";margin:0;color:var(--text);background:linear-gradient(180deg,#0b1220,#0d1424 35%,#0f1628)}
    header{position:sticky;top:0;z-index:20;background:rgba(11,18,32,.75);backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
    nav{display:flex;gap:.5rem;align-items:center;max-width:1100px;margin:0 auto;padding:.75rem 1rem}
    nav a, nav button{color:#cfe2ff;text-decoration:none;font-weight:600;padding:.5rem .75rem;border-radius:12px;border:1px solid #223352;background:#1b2942;cursor:pointer}
    nav a[aria-current="page"],nav a:hover,nav button:hover{background:#223352}
    main{max-width:1100px;margin:0 auto;padding:1rem}
    .tab{display:none}.tab.active{display:block}
    .grid{display:grid;gap:1rem}@media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;padding:1rem;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h2{margin:.25rem 0 1rem}
    iframe{border:0;width:100%;border-radius:12px}
    input,select,textarea,button{width:100%;padding:.7rem .8rem;border-radius:12px;border:1px solid #25364f;background:#0f172a;color:var(--text)}
    textarea{min-height:90px}
    button{cursor:pointer;background:#1b8f3f;border:1px solid #1e9a45;font-weight:700}
    button.secondary{background:#1b2942;border-color:#223352}
    button.danger{background:#7a1f1b;border-color:#8a241f}
    .row{display:flex;gap:.5rem;flex-wrap:wrap}.row>*{flex:1 1 220px}
    .list{max-height:420px;overflow:auto}
    .pill{display:inline-flex;align-items:center;gap:.5ch;background:#11213a;border:1px solid #223352;border-radius:999px;padding:.2rem .6rem;font-size:.85rem;color:#cfe2ff}
    .badge{display:inline-flex;align-items:center;gap:.4ch;border-radius:999px;padding:.1rem .5rem;font-weight:700;font-size:.75rem}
    .badge.rev{background:#10361f;border:1px solid #174b29;color:#b9f0c3}
    .badge.rendre{background:#3a1412;border:1px solid #4e1a17;color:#ffcdc7}
    .badge.prep{background:#102247;border:1px solid #183066;color:#cfe2ff}
    .badge.lect{background:#241451;border:1px solid #2e1a69;color:#e6d9ff}
    .tile{border:1px solid #243349;background:#0f172a;border-radius:12px;padding:.75rem;margin:.5rem 0}
    .progress{background:#1f2a3d;border-radius:999px;overflow:hidden;height:10px;margin-top:6px}
    .bar{background:var(--primary);height:100%;transition:width .3s ease}
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0}
    .planning-table{width:100%;border-collapse:separate;border-spacing:0 12px}
    .planning-table th,.planning-table td{vertical-align:top;text-align:left}
    .planning-table th{font-size:.95rem;color:#cfe2ff;padding:.25rem .5rem}
    .planning-col{background:#0f172a;border:1px solid #243349;border-radius:12px;padding:.75rem}
    .muted{color:var(--muted)}
    .hidden{display:none}
  </style>

  <!-- Supabase (CDN) + config int√©gr√©e : REMPLACE ICI tes 2 valeurs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ========= REMPLACE ICI ========= */
    const SUPABASE_URL = "https://smxqtzbqachmzefyjpuj.supabase.co";       /* <-- remplace */
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNteHF0emJxYWNobXplZnlqcHVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTY5ODMsImV4cCI6MjA3MjM3Mjk4M30.F2X2j_YqSlvMwr8Pa9PzFt3p0c4LlrBCE95FkyFUwVc";                 /* <-- remplace */
    /* ================================= */
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const REDIRECT_URL = "https://planning-revisions.vercel.app"; /* redirection forc√©e */
  </script>
</head>
<body>
  <header>
    <nav aria-label="Onglets">
      <a href="#" data-tab="accueil" aria-current="page">Accueil</a>
      <a href="#" data-tab="saisies">Saisies du jour</a>
      <a href="#" data-tab="planning">Planning √† 5 jours</a>
      <a href="#" data-tab="agenda">Agenda</a>
      <a href="#" data-tab="matieres">Mati√®res</a>
      <!-- Boutons Auth -->
      <div style="margin-left:auto; display:flex; gap:.5rem">
        <button id="btnSignIn" class="secondary" type="button">S'identifier</button>
<button id="btnConnect" class="secondary" type="button" style="display:none">Connecter au cloud</button>
<button id="btnLogout" class="secondary" type="button" style="display:none">Se d√©connecter</button>
<!-- anciens boutons conserv√©s cach√©s pour compat -->
<button id="btnLogin" class="secondary" type="button" style="display:none"></button>
<button id="btnLoginCode" class="secondary" type="button" style="display:none"></button>

      </div>
    </nav>
  </header>

  <main>
    <!-- ACCUEIL -->
    <section class="tab active" id="accueil">
      <div class="grid">
        <div class="card">
          <h2>Bonjour Octave</h2>
          <p class="muted">Bienvenue ‚Äî musique du jour.</p>
          <h3>üéµ Musique</h3>
          <iframe title="Lecteur Deezer" scrolling="no" allowtransparency="true"
            src="https://www.deezer.com/plugins/player?format=classic&autoplay=false&playlist=true&width=700&height=350&color=007FEB&layout=dark&size=medium&type=tracks&id=3135556&app_id=1"
            height="100"></iframe>
        </div>
      </div>
    </section>

    <!-- SAISIES -->
    <section class="tab" id="saisies">
      <div class="card">
        <h2>Saisies du jour</h2>
        <div class="row">
          <select id="typeSelect" aria-label="Type">
            <option value="revision">R√©vision</option>
            <option value="devoir_rendre">Devoir √† rendre</option>
            <option value="devoir_preparer">Devoir √† pr√©parer</option>
            <option value="lecture">Lecture</option>
          </select>
          <select id="matiereSelect" aria-label="Mati√®re"></select>
          <input id="titreInput" placeholder="Titre (ex. DM fonctions / Lecture Candide)" />
        </div>
        <div class="row">
          <textarea id="descriptionInput" placeholder="Description / consignes / notes..."></textarea>
        </div>

        <!-- Sp√©cifiques par type -->
        <div id="formRevision" class="row">
          <input id="dateRevision" type="date" aria-label="Date de r√©vision" />
          <div class="pill">Jalons: 0,1,3,7,15,30 jours</div>
        </div>

        <div id="formRendre" class="row hidden">
          <input id="echeanceRendre" type="date" aria-label="√âch√©ance" />
          <select id="prioriteRendre">
            <option value="1">Priorit√© normale</option>
            <option value="2">Haute</option>
            <option value="0">Basse</option>
          </select>
        </div>

        <div id="formPreparer" class="row hidden">
          <input id="echeancePreparer" type="date" aria-label="√âch√©ance" />
          <input id="dureeTotale" type="number" min="15" step="5" placeholder="Dur√©e totale estim√©e (min)" />
          <button id="btnPlanifierAuto" class="secondary" style="width:auto" type="button">Planifier maintenant</button>
        </div>

        <div id="formLecture" class="row hidden">
          <input id="ouvrageTitre" placeholder="Titre de l'ouvrage" />
          <input id="ouvrageAuteur" placeholder="Auteur (optionnel)" />
          <input id="chapitresTotal" type="number" min="1" placeholder="Nombre de chapitres" />
          <input id="echeanceLecture" type="date" aria-label="√âch√©ance lecture (optionnelle)" />
          <button id="btnRepartirLecture" class="secondary" style="width:auto" type="button">R√©partir maintenant</button>
        </div>

        <div class="toolbar">
          <button id="btnSauver" type="button">Ajouter</button>
          <button class="secondary" id="btnExporter" type="button">Exporter JSON</button>
          <label class="pill" for="importInput">Importer JSON
            <input id="importInput" type="file" accept="application/json" class="hidden" />
          </label>
        </div>

        <div id="listeItems" class="list"></div>
      </div>
    </section>

    <!-- PLANNING -->
    <section class="tab" id="planning">
      <div class="card">
        <h2 style="text-align:center">Planning √† 5 jours</h2>
        <table class="planning-table" id="planningTable">
          <thead><tr id="planningHeader"></tr></thead>
          <tbody><tr id="planningRow"></tr></tbody>
        </table>
      </div>
    </section>

    <!-- AGENDA -->
    <section class="tab" id="agenda">
      <div class="card">
        <h2>Agenda</h2>
        <div class="toolbar">
          <input id="rechercheAgenda" placeholder="Rechercher (mati√®re, titre, description)" />
          <select id="filtreMatiere"></select>
          <select id="filtreType">
            <option value="">Tous les types</option>
            <option value="revision">R√©vision</option>
            <option value="devoir_rendre">√Ä rendre</option>
            <option value="devoir_preparer">√Ä pr√©parer</option>
            <option value="lecture">Lecture</option>
          </select>
          <button class="secondary" id="btnAujourdHui" type="button">Aller √† aujourd'hui</button>
        </div>
        <div id="agendaContent" class="list"></div>
      </div>
    </section>

    <!-- MATIERES -->
    <section class="tab" id="matieres">
      <div class="card">
        <h2>Mati√®res</h2>
        <div class="row">
          <input id="nouvelleMatiere" placeholder="Nouvelle mati√®re" type="text" />
          <button id="btnAjouterMatiere" type="button">Ajouter</button>
        </div>
        <ul id="listeMatieres" class="list"></ul>
      </div>
    </section>
  </main>

  <!-- Template pour un item -->
  <template id="itemTpl">
    <div class="tile" data-id="">
      <div class="row" style="align-items:center">
        <span class="badge" data-badge></span>
        <span class="pill" data-matiere></span>
        <span class="muted" data-info></span>
      </div>
      <h4 style="margin:.5rem 0" data-titre></h4>
      <p class="muted" data-desc></p>
      <div class="progress" aria-hidden="true"><div class="bar" data-bar style="width:0%"></div></div>
      <div class="row" style="margin-top:.5rem">
        <button data-edit class="secondary" type="button">Modifier</button>
        <button data-done class="secondary" type="button">Marquer termin√©</button>
        <button data-pluschap class="secondary hidden" type="button">+1 chapitre lu</button>
        <button data-delete class="danger" type="button">Supprimer</button>
      </div>
    </div>
  </template>

  <script>
    /* ===================== UTILITAIRES ===================== */
    const JALONS=[0,1,3,7,15,30], FR='fr-FR';
    const fmtDateLabel=d=>d.toLocaleDateString(FR,{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
    const toLocalDate=s=>new Date(`${s}T00:00:00`);
    const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x};
    const isoDate=d=>d.toISOString().slice(0,10);
    const todayIso=()=>isoDate(new Date());
    // XSS minimal (corrig√©)
    const escapeHtml=(str='')=>str.replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));

    /* ===================== STORE LOCAL ===================== */
    const store={
      get matieres(){return JSON.parse(localStorage.getItem('matieres'))||['Math√©matiques','Physique-chimie','Fran√ßais','Histoire-g√©ographie','Anglais','Espagnol','Enseignement moral et civique','Techno','Enseignement Sp√©cifique','EPS']},
      set matieres(v){localStorage.setItem('matieres',JSON.stringify(v))},
      get items(){return JSON.parse(localStorage.getItem('items_v3'))||[]},
      set items(v){localStorage.setItem('items_v3',JSON.stringify(v))}
    };

    // Migration √©ventuelle depuis anciens formats
    (function migrate(){
      if(!localStorage.getItem('items_v3')){
        const revs=JSON.parse(localStorage.getItem('revisions_v2'))||JSON.parse(localStorage.getItem('revisions'))||[];
        const mapped=(revs||[]).map(r=>({
          id:crypto.randomUUID(), type:'revision', matiere:r.matiere,
          titre:r.contenu?.slice(0,80)||'R√©vision', description:r.commentaire||'',
          dateCreation:Date.now(), etat:'a_faire', baseDate:r.date, jalons:[...JALONS]
        }));
        if(mapped.length) localStorage.setItem('items_v3',JSON.stringify(mapped));
      }
    })();

    /* ===================== ELEMENTS ===================== */
    const els={
      tabs:document.querySelectorAll('nav a[data-tab]'),
      typeSelect:document.getElementById('typeSelect'),
      matiereSelect:document.getElementById('matiereSelect'),
      titreInput:document.getElementById('titreInput'),
      descriptionInput:document.getElementById('descriptionInput'),
      formRevision:document.getElementById('formRevision'),
      formRendre:document.getElementById('formRendre'),
      formPreparer:document.getElementById('formPreparer'),
      formLecture:document.getElementById('formLecture'),
      dateRevision:document.getElementById('dateRevision'),
      echeanceRendre:document.getElementById('echeanceRendre'),
      prioriteRendre:document.getElementById('prioriteRendre'),
      echeancePreparer:document.getElementById('echeancePreparer'),
      dureeTotale:document.getElementById('dureeTotale'),
      btnPlanifierAuto:document.getElementById('btnPlanifierAuto'),
      ouvrageTitre:document.getElementById('ouvrageTitre'),
      ouvrageAuteur:document.getElementById('ouvrageAuteur'),
      chapitresTotal:document.getElementById('chapitresTotal'),
      echeanceLecture:document.getElementById('echeanceLecture'),
      btnRepartirLecture:document.getElementById('btnRepartirLecture'),
      btnSauver:document.getElementById('btnSauver'),
      listeItems:document.getElementById('listeItems'),
      planningHeader:document.getElementById('planningHeader'),
      planningRow:document.getElementById('planningRow'),
      agendaContent:document.getElementById('agendaContent'),
      rechercheAgenda:document.getElementById('rechercheAgenda'),
      filtreMatiere:document.getElementById('filtreMatiere'),
      filtreType:document.getElementById('filtreType'),
      nouvelleMatiere:document.getElementById('nouvelleMatiere'),
      listeMatieres:document.getElementById('listeMatieres')
    };

    /* ===================== NAV TABS ===================== */
    document.querySelectorAll('nav a[data-tab]').forEach(a=>a.addEventListener('click',e=>{
      e.preventDefault();
      const id=a.getAttribute('data-tab');
      document.querySelectorAll('nav a[data-tab]').forEach(t=>t.removeAttribute('aria-current'));
      a.setAttribute('aria-current','page');
      document.querySelectorAll('.tab').forEach(tab=>tab.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }));

    /* ===================== MATIERES UI ===================== */
    function renderMatieres(){
      const ms=[...store.matieres].sort((a,b)=>a.localeCompare(b,'fr'));
      els.matiereSelect.innerHTML=ms.map(m=>`<option value="${m}">${m}</option>`).join('');
      els.filtreMatiere.innerHTML=`<option value="">Toutes les mati√®res</option>`+ms.map(m=>`<option>${m}</option>`).join('');
      els.listeMatieres.innerHTML='';
      ms.forEach(m=>{
        const utilisee=store.items.some(r=>r.matiere===m);
        const li=document.createElement('li'); li.innerHTML=`<span class="pill">${escapeHtml(m)}</span>`;
        if(!utilisee){
          const btn=document.createElement('button'); btn.textContent='Supprimer'; btn.className='danger'; btn.style.width='auto';
          btn.addEventListener('click',()=>{ if(confirm('Supprimer cette mati√®re ?')){ store.matieres=store.matieres.filter(x=>x!==m); renderMatieres(); }});
          li.append(' ',btn);
        }
        els.listeMatieres.appendChild(li);
      });
    }
    document.getElementById('btnAjouterMatiere').addEventListener('click',()=>{
      const m=els.nouvelleMatiere.value.trim(); if(m&&!store.matieres.includes(m)){ store.matieres=[...store.matieres,m]; els.nouvelleMatiere.value=''; renderMatieres(); }
    });

    /* ===================== ITEMS (CRUD) ===================== */
    let addItem=obj=>{store.items=[...store.items,obj]};
    let updateItem=(id,patch)=>{store.items=store.items.map(i=>i.id===id?{...i,...patch}:i)};
    let deleteItem=id=>{store.items=store.items.filter(i=>i.id!==id)};

    function switchTypeUI(){
      const t=els.typeSelect.value;
      els.formRevision.classList.toggle('hidden',t!=='revision');
      els.formRendre.classList.toggle('hidden',t!=='devoir_rendre');
      els.formPreparer.classList.toggle('hidden',t!=='devoir_preparer');
      els.formLecture.classList.toggle('hidden',t!=='lecture');
    }
    els.typeSelect.addEventListener('change',switchTypeUI);
    els.dateRevision.value=todayIso(); els.echeanceRendre.value=todayIso(); els.echeancePreparer.value=todayIso(); els.echeanceLecture.value='';

    let editingId=null, pendingSessions=null, pendingRepartition=null;

    function clearForm(){
      editingId=null; pendingSessions=null; pendingRepartition=null; document.getElementById('btnSauver').textContent='Ajouter';
      els.titreInput.value=''; els.descriptionInput.value=''; els.dateRevision.value=todayIso(); els.echeanceRendre.value=todayIso();
      els.echeancePreparer.value=todayIso(); els.dureeTotale.value=''; els.ouvrageTitre.value=''; els.ouvrageAuteur.value='';
      els.chapitresTotal.value=''; els.echeanceLecture.value=''; els.typeSelect.value='revision'; switchTypeUI();
    }

    document.getElementById('btnSauver').addEventListener('click',()=>{
      const type=els.typeSelect.value, matiere=els.matiereSelect.value;
      const titre=els.titreInput.value.trim()||(type==='lecture'?(els.ouvrageTitre.value.trim()||'Lecture'):'Sans titre');
      const description=els.descriptionInput.value.trim();
      if(!matiere) return alert('Choisis une mati√®re.');
      let payload={id:editingId||crypto.randomUUID(),type,matiere,titre,description,dateCreation:Date.now(),etat:'a_faire'};

      if(type==='revision'){
        const baseDate=els.dateRevision.value; if(!baseDate) return alert('Date requise.');
        payload={...payload,baseDate,jalons:[...JALONS]};
      }
      if(type==='devoir_rendre'){
        const echeance=els.echeanceRendre.value; if(!echeance) return alert('√âch√©ance requise.');
        payload={...payload,echeance,priorite:Number(els.prioriteRendre.value),progress:0};
      }
      if(type==='devoir_preparer'){
        const echeance=els.echeancePreparer.value; if(!echeance) return alert('√âch√©ance requise.');
        const dureeTotale=Number(els.dureeTotale.value||0); if(!dureeTotale) return alert('Indique la dur√©e totale estim√©e.');
        payload={...payload,echeance,dureeTotaleEstimee:dureeTotale,sessions:pendingSessions||[]};
      }
      if(type==='lecture'){
        const titreO=els.ouvrageTitre.value.trim(); if(!titreO) return alert("Titre de l'ouvrage requis.");
        const chapTotal=Number(els.chapitresTotal.value||0); if(!chapTotal) return alert('Nombre de chapitres requis.');
        const echeance=els.echeanceLecture.value||null;
        payload={...payload,ouvrage:{titre:titreO,auteur:els.ouvrageAuteur.value.trim()||''},chapitresTotal:chapTotal,chapitresLus:0,echeance,repartition:pendingRepartition||[]};
      }

      if(editingId) updateItem(editingId,payload); else addItem(payload);
      clearForm(); refreshAll();
    });

    document.getElementById('btnPlanifierAuto').addEventListener('click',()=>{
      const echeance=els.echeancePreparer.value, dureeTotale=Number(els.dureeTotale.value||0);
      if(!echeance||!dureeTotale) return alert('√âch√©ance et dur√©e requises.');
      const start=toLocalDate(todayIso()), end=toLocalDate(echeance);
      const days=Math.max(1,Math.ceil((end-start)/86400000)), chunk=30, sessionsCount=Math.max(1,Math.ceil(dureeTotale/chunk));
      const sessions=Array.from({length:sessionsCount},(_,i)=>({date:isoDate(addDays(start,Math.round(i*(days-1)/Math.max(1,sessionsCount-1)))),duree:chunk,fait:false}));
      if(editingId){const it=store.items.find(x=>x.id===editingId); if(it&&it.type==='devoir_preparer'){updateItem(editingId,{sessions}); alert(`Plan cr√©√©: ${sessions.length} sessions de ${chunk} min.`); refreshAll(); return;}}
      pendingSessions=sessions; alert(`Plan pr√™t: ${sessions.length} sessions seront ajout√©es √† l'enregistrement.`);
    });

    document.getElementById('btnRepartirLecture').addEventListener('click',()=>{
      const chapTotal=Number(els.chapitresTotal.value||0), echeance=els.echeanceLecture.value;
      if(!(chapTotal&&echeance)) return alert('Indique le nombre de chapitres et une √©ch√©ance.');
      const start=toLocalDate(todayIso()), end=toLocalDate(echeance), days=Math.max(1,Math.ceil((end-start)/86400000));
      const base=Math.floor(chapTotal/days), extra=chapTotal%days;
      const repartition=Array.from({length:days},(_,i)=>{const nb=base+(i<extra?1:0);return{date:isoDate(addDays(start,i)),chapitres:nb,fait:false}}).filter(p=>p.chapitres>0);
      if(editingId){const it=store.items.find(x=>x.id===editingId); if(it&&it.type==='lecture'){updateItem(editingId,{repartition}); alert(`R√©partition cr√©√©e: ${repartition.length} jours.`); refreshAll(); return;}}
      pendingRepartition=repartition; alert(`R√©partition pr√™te: ${repartition.length} jours seront ajout√©s √† l'enregistrement.`);
    });

    function badgeFor(t){const s=document.createElement('span'); s.className='badge '+(t==='revision'?'rev':t==='devoir_rendre'?'rendre':t==='devoir_preparer'?'prep':'lect'); s.textContent=t==='revision'?'R√©vision':t==='devoir_rendre'?'√Ä rendre':t==='devoir_preparer'?'√Ä pr√©parer':'Lecture'; return s;}
    function percentFor(item){
      if(item.type==='revision'){const today=toLocalDate(todayIso()), base=toLocalDate(item.baseDate); const diff=Math.round((today-base)/86400000); const idx=item.jalons.findIndex(j=>j===diff); return idx>=0?Math.round(((idx+1)/item.jalons.length)*100):0;}
      if(item.type==='devoir_rendre') return Number(item.progress||0);
      if(item.type==='devoir_preparer'){const t=(item.sessions||[]).length||0, d=(item.sessions||[]).filter(s=>s.fait).length; return t?Math.round(100*d/t):0;}
      if(item.type==='lecture') return item.chapitresTotal?Math.round(100*(item.chapitresLus||0)/item.chapitresTotal):0;
      return 0;
    }
    function infoFor(it){
      if(it.type==='revision') return `Base: ${fmtDateLabel(toLocalDate(it.baseDate))}`;
      if(it.type==='devoir_rendre') return `√âch√©ance: ${fmtDateLabel(toLocalDate(it.echeance))}`;
      if(it.type==='devoir_preparer') return `√âch√©ance: ${fmtDateLabel(toLocalDate(it.echeance))}`;
      if(it.type==='lecture'){const p=[`${it.chapitresLus||0}/${it.chapitresTotal} chap.`]; if(it.echeance) p.push(`√âch√©ance: ${fmtDateLabel(toLocalDate(it.echeance))}`); return p.join(' ‚Äî ');}
      return '';
    }

    function renderItems(){
      const items=[...store.items].sort((a,b)=>{const pa=(a.type==='devoir_rendre'||a.type==='devoir_preparer')?(a.echeance||'9999'):'9999'; const pb=(b.type==='devoir_rendre'||b.type==='devoir_preparer')?(b.echeance||'9999'):'9999'; return pa.localeCompare(pb)||(b.dateCreation-a.dateCreation)});
      els.listeItems.innerHTML=''; const tpl=document.getElementById('itemTpl');
      items.forEach(it=>{
        const node=tpl.content.cloneNode(true), root=node.querySelector('.tile'); root.dataset.id=it.id;
        const b=badgeFor(it.type); node.querySelector('[data-badge]').replaceWith(b);
        node.querySelector('[data-matiere]').textContent=it.matiere;
        node.querySelector('[data-info]').textContent=infoFor(it);
        node.querySelector('[data-titre]').textContent=it.titre;
        node.querySelector('[data-desc]').textContent=it.description||'';
        node.querySelector('[data-bar]').style.width=percentFor(it)+'%';
        node.querySelector('[data-edit]').addEventListener('click',()=>startEdit(it));
        node.querySelector('[data-done]').addEventListener('click',()=>{updateItem(it.id,{etat:'termine',progress:100}); refreshAll();});
        node.querySelector('[data-delete]').addEventListener('click',()=>{if(confirm('Supprimer ?')){deleteItem(it.id); refreshAll();}});
        const plus=node.querySelector('[data-pluschap]');
        if(it.type==='lecture'){
          plus.classList.remove('hidden');
          plus.addEventListener('click',()=>{const v=Math.min(it.chapitresTotal,(it.chapitresLus||0)+1); updateItem(it.id,{chapitresLus:v}); refreshAll();});
        }
        els.listeItems.appendChild(node);
      });
    }

    function startEdit(it){
      editingId=it.id; pendingSessions=null; pendingRepartition=null; document.getElementById('btnSauver').textContent='Mettre √† jour';
      els.typeSelect.value=it.type; switchTypeUI();
      els.matiereSelect.value=it.matiere;
      els.titreInput.value=it.titre;
      els.descriptionInput.value=it.description||'';
      if(it.type==='revision'){ els.dateRevision.value=it.baseDate; }
      if(it.type==='devoir_rendre'){ els.echeanceRendre.value=it.echeance; els.prioriteRendre.value=String(it.priorite??1); }
      if(it.type==='devoir_preparer'){ els.echeancePreparer.value=it.echeance; els.dureeTotale.value=it.dureeTotaleEstimee||''; }
      if(it.type==='lecture'){
        els.ouvrageTitre.value=it.ouvrage?.titre||''; els.ouvrageAuteur.value=it.ouvrage?.auteur||'';
        els.chapitresTotal.value=it.chapitresTotal||''; els.echeanceLecture.value=it.echeance||'';
      }
      document.querySelector('a[data-tab="saisies"]').click();
    }

    /* ===================== PLANNING (5 jours) ===================== */
    function renderPlanning(){
      const start=toLocalDate(todayIso());
      const days=Array.from({length:5},(_,i)=>{const d=addDays(start,i);return{date:isoDate(d),label:fmtDateLabel(d),html:[]};});

      // R√©visions (jalons)
      store.items.filter(i=>i.type==='revision').forEach(r=>{
        const base=toLocalDate(r.baseDate);
        r.jalons.forEach((j,idx)=>{
          const d=isoDate(addDays(base,j));
          const col=days.find(x=>x.date===d); if(!col) return;
          const prog=Math.round(((idx+1)/r.jalons.length)*100);
          col.html.push(`<div class="tile"><span class="badge rev">R√©vision</span> <strong>${escapeHtml(r.matiere)}</strong><br><em>${escapeHtml(r.titre)}</em><div class="progress"><div class="bar" style="width:${prog}%"></div></div></div>`);
        });
      });

      // √Ä pr√©parer (sessions + √©ch√©ance)
      store.items.filter(i=>i.type==='devoir_preparer').forEach(p=>{
        (p.sessions||[]).forEach(s=>{
          const col=days.find(x=>x.date===s.date); if(!col) return;
          col.html.push(`<div class="tile"><span class="badge prep">Pr√©parer</span> <strong>${escapeHtml(p.matiere)}</strong> ‚Äî ${escapeHtml(p.titre)}<br><span class="muted">Session ${s.duree} min</span><div class="progress"><div class="bar" style="width:${s.fait?100:0}%"></div></div></div>`);
        });
        const colE=days.find(x=>x.date===p.echeance); if(colE) colE.html.push(`<div class="tile"><span class="badge prep">√âch√©ance</span> <strong>${escapeHtml(p.matiere)}</strong> ‚Äî ${escapeHtml(p.titre)}</div>`);
      });

      // √Ä rendre (√©ch√©ance)
      store.items.filter(i=>i.type==='devoir_rendre').forEach(dv=>{
        const col=days.find(x=>x.date===dv.echeance); if(!col) return;
        col.html.push(`<div class="tile"><span class="badge rendre">√Ä rendre</span> <strong>${escapeHtml(dv.matiere)}</strong> ‚Äî ${escapeHtml(dv.titre)}<div class="progress"><div class="bar" style="width:${Number(dv.progress||0)}%"></div></div></div>`);
      });

      // Lecture (r√©partition)
      store.items.filter(i=>i.type==='lecture').forEach(le=>{
        (le.repartition||[]).forEach(part=>{
          const col=days.find(x=>x.date===part.date); if(!col) return;
          col.html.push(`<div class="tile"><span class="badge lect">Lecture</span> <strong>${escapeHtml(le.ouvrage?.titre||le.titre)}</strong> ‚Äî ${part.chapitres} chap.</div>`);
        });
      });

      els.planningHeader.innerHTML=''; els.planningRow.innerHTML='';
      days.forEach(d=>{
        const th=document.createElement('th'); th.textContent=d.label; els.planningHeader.appendChild(th);
        const td=document.createElement('td'); td.className='planning-col'; td.innerHTML=d.html.join('')||'<em class="muted">Aucune t√¢che</em>'; els.planningRow.appendChild(td);
      });
    }

    /* ===================== AGENDA ===================== */
    function renderAgenda(){
      const itemsByDate={};

      // R√©visions
      store.items.filter(i=>i.type==='revision').forEach(r=>{
        const base=toLocalDate(r.baseDate);
        r.jalons.forEach((j,idx)=>{
          const d=isoDate(addDays(base,j));
          (itemsByDate[d] ||= []).push({type:'revision', matiere:r.matiere, titre:r.titre, desc:r.description, prog:Math.round(((idx+1)/r.jalons.length)*100)});
        });
      });
      // Pr√©parer
      store.items.filter(i=>i.type==='devoir_preparer').forEach(p=>{
        (p.sessions||[]).forEach(s=>{ (itemsByDate[s.date] ||= []).push({type:'devoir_preparer', matiere:p.matiere, titre:p.titre, desc:`Session ${s.duree} min`, prog: s.fait?100:0}); });
        (itemsByDate[p.echeance] ||= []).push({type:'devoir_preparer', matiere:p.matiere, titre:p.titre, desc:'√âch√©ance', prog: percentFor(p)});
      });
      // Rendre
      store.items.filter(i=>i.type==='devoir_rendre').forEach(dv=>{
        (itemsByDate[dv.echeance] ||= []).push({type:'devoir_rendre', matiere:dv.matiere, titre:dv.titre, desc:'√Ä rendre', prog:Number(dv.progress||0)});
      });
      // Lecture
      store.items.filter(i=>i.type==='lecture').forEach(le=>{
        (le.repartition||[]).forEach(part=>{ (itemsByDate[part.date] ||= []).push({type:'lecture', matiere:le.matiere, titre:le.ouvrage?.titre||le.titre, desc:`${part.chapitres} chap.`, prog: percentFor(le)}); });
      });

      const q=els.rechercheAgenda.value.trim().toLowerCase();
      const fm=els.filtreMatiere.value, ft=els.filtreType.value;

      const dates=Object.keys(itemsByDate).sort();
      els.agendaContent.innerHTML='';
      dates.forEach((d,i)=>{
        let list=itemsByDate[d];
        if(fm) list=list.filter(x=>x.matiere===fm);
        if(ft) list=list.filter(x=>x.type===ft);
        if(q) list=list.filter(x=>[x.matiere,x.titre,x.desc].join(' ').toLowerCase().includes(q));
        if(!list.length) return;
        const wrap=document.createElement('div');
        wrap.dataset.date=d;
        wrap.style.background=i%2? '#0e1526' : '#0e1322';
        wrap.style.padding='10px'; wrap.style.marginBottom='8px';
        wrap.innerHTML=`<h4 style="margin:.25rem 0">${fmtDateLabel(toLocalDate(d))}</h4>`;
        list.forEach(p=>{
          const tile=document.createElement('div'); tile.className='tile';
          const b=badgeFor(p.type).outerHTML;
          tile.innerHTML=`${b} <strong>${escapeHtml(p.matiere)}</strong><br><em>${escapeHtml(p.titre)}</em><br><span class="muted">${escapeHtml(p.desc||'')}</span><div class="progress"><div class="bar" style="width:${p.prog||0}%"></div></div>`;
          wrap.appendChild(tile);
        });
        els.agendaContent.appendChild(wrap);
      });
    }

    document.getElementById('btnAujourdHui').addEventListener('click',()=>{
      const today=todayIso(); els.agendaContent.querySelector(`[data-date="${today}"]`)?.scrollIntoView({behavior:'smooth',block:'start'});
    });
    els.rechercheAgenda.addEventListener('input',renderAgenda);
    els.filtreMatiere.addEventListener('change',renderAgenda);
    els.filtreType.addEventListener('change',renderAgenda);

    /* ===================== EXPORT / IMPORT ===================== */
    document.getElementById('btnExporter').addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify({matieres:store.matieres,items:store.items},null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`planning-v3-${todayIso()}.json`; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('importInput').addEventListener('change',e=>{
      const file=e.target.files?.[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const data=JSON.parse(reader.result);
          if(Array.isArray(data.matieres)) store.matieres=data.matieres;
          if(Array.isArray(data.items)) store.items=data.items.map(x=>x.id?x:{...x,id:crypto.randomUUID()});
          renderMatieres(); refreshAll(); alert('Import effectu√©.');
        }catch(err){ alert('Fichier invalide.'); }
      };
      reader.readAsText(file);
    });

    /* ===================== INITIALISATION ===================== */
    function refreshAll(){ renderItems(); renderPlanning(); renderAgenda(); renderMatieres(); }
    renderMatieres(); switchTypeUI(); refreshAll();

    /* ===================== AUTH & SYNC SUPABASE ===================== */
    const btnLogin=document.getElementById('btnLogin');
    const btnLoginCode=document.getElementById('btnLoginCode');
    const btnLogout=document.getElementById('btnLogout');
    let mode='local';

// === New auth UI controls (sign-in -> connect -> disconnect), planning untouched ===
const btnSignIn = document.getElementById('btnSignIn');
const btnConnect = document.getElementById('btnConnect');
function updateAuthUI2({isAuthed, isConnected}){
  if(!isAuthed){
    btnSignIn && (btnSignIn.style.display='');
    btnConnect && (btnConnect.style.display='none');
    btnLogout && (btnLogout.style.display='none');
    return;
  }
  if(isConnected){
    btnSignIn && (btnSignIn.style.display='none');
    btnConnect && (btnConnect.style.display='none');
    btnLogout && (btnLogout.style.display='');
  }else{
    btnSignIn && (btnSignIn.style.display='none');
    btnConnect && (btnConnect.style.display='');
    btnLogout && (btnLogout.style.display='none');
  }
}

// Sign in via OTP (code 6 chiffres) ‚Äî pas d‚Äôauto-connexion cloud
btnSignIn?.addEventListener('click', async ()=>{
  const email = prompt("Entre ton email pour recevoir un code (6 chiffres) :");
  if(!email) return;
  const { error } = await window.sb.auth.signInWithOtp({ email, options:{ shouldCreateUser:true } });
  if(error) return alert("Erreur: " + error.message);
  const token = prompt("Code re√ßu par email (6 chiffres) :");
  if(!token) return;
  const { error: e2 } = await window.sb.auth.verifyOtp({ email, token, type:'email' });
  if(e2) return alert("Erreur v√©rification code: " + e2.message);
  alert("Identification r√©ussie. Tu peux maintenant te connecter au cloud.");
  updateAuthUI2({ isAuthed:true, isConnected: mode==='cloud' });
});

// Connexion cloud explicite (migration si cloud vide)
btnConnect?.addEventListener('click', async ()=>{
  const { data:{ user } } = await window.sb.auth.getUser();
  if(!user) return alert("Identifie-toi d'abord.");
  await ensureProfile(user);
  await maybeMigrateLocalToCloud(user);
  await loadFromCloud(user);
  mode='cloud';
  updateAuthUI2({ isAuthed:true, isConnected:true });
  alert("Connect√© au cloud.");
});

 // 'local' | 'cloud'

    // Magic link (redir vers ton domaine Vercel)
    btnLogin?.addEventListener('click', async ()=>{
      const email=prompt("Entre ton email pour recevoir un lien de connexion :");
      if(!email) return;
      const { error } = await window.sb.auth.signInWithOtp({
        email,
        options:{ emailRedirectTo: REDIRECT_URL, shouldCreateUser: true }
      });
      if(error) return alert("Erreur: " + error.message);
      alert("V√©rifie ta bo√Æte mail et clique sur le lien depuis CET appareil.");
    });

    // Connexion par code (OTP)
    btnLoginCode?.addEventListener('click', async ()=>{
      const email = prompt("Ton email :");
      if(!email) return;

      // √âtape 1 : envoi du code par email
      const { error } = await window.sb.auth.signInWithOtp({
        email,
        options:{ shouldCreateUser: true }
      });
      if (error) return alert("Erreur envoi code: " + error.message);

      // √âtape 2 : saisie du code re√ßu
      const token = prompt("Entre le code √† 6 chiffres re√ßu par email :");
      if (!token) return;

      const { error: e2 } = await window.sb.auth.verifyOtp({
        email,
        token,
        type: 'email'
      });
      if (e2) return alert("Erreur v√©rification code: " + e2.message);
      alert("Connexion r√©ussie !");
    });

    // D√©connexion
    btnLogout?.addEventListener('click', async ()=>{
      mode='local';
      await window.sb.auth.signOut();
      updateAuthUI2({ isAuthed:false, isConnected:false });
      alert("D√©connect√©.");
    });

    async function ensureProfile(user){
      try{ await window.sb.from('profiles').upsert({ id:user.id, email:user.email }).select().single(); }catch(e){ console.warn(e); }
    }

    async function maybeMigrateLocalToCloud(user){
      const { data:rows, error } = await window.sb.from('items_v3').select('id').limit(1);
      if(error){ console.error(error); return; }
      if(rows && rows.length) return;
      const localItems=store.items||[]; if(!localItems.length) return;
      const upserts=localItems.map(it=>({ id:it.id||crypto.randomUUID(), owner_id:user.id, data:it }));
      const { error:e2 } = await window.sb.from('items_v3').upsert(upserts);
      if(e2){ console.error(e2); return; }
      mode='cloud';
      alert("Migration effectu√©e : tes donn√©es locales sont maintenant en ligne.");
    }

    async function loadFromCloud(user){
      const { data, error } = await window.sb.from('items_v3').select('id,data,updated_at').eq('owner_id',user.id).order('created_at',{ascending:true});
      if(error){ console.error(error); return; }
      const items=(data||[]).map(r=>({ ...r.data, id:r.data.id||r.id }));
      store.items=items; mode='cloud'; refreshAll();
    }

    window.sb.
    window.sb.auth.onAuthStateChange(async (_ev, session)=>{
      const isAuthed = !!session?.user;
      const isConnected = isAuthed && mode==='cloud';
      updateAuthUI2({ isAuthed, isConnected });
    });
    await maybeMigrateLocalToCloud(user);
        await loadFromCloud(user);
      }else{
        mode='local';
        btnLogin.style.display=''; btnLoginCode.style.display=''; btnLogout.style.display='none';
      }
    });

    const _addItem=addItem, _updateItem=updateItem, _deleteItem=deleteItem;
    addItem=(obj)=>{ _addItem(obj); if(mode==='cloud') upsertCloud([obj]); };
    updateItem=(id,patch)=>{ _updateItem(id,patch); if(mode==='cloud'){ const it=store.items.find(i=>i.id===id); if(it) upsertCloud([it]); } };
    deleteItem=(id)=>{ const it=store.items.find(i=>i.id===id); _deleteItem(id); if(mode==='cloud'&&it) deleteCloud(id); };

    async function upsertCloud(items){
      const { data:{ user } } = await window.sb.auth.getUser();
      if(!user) return;
      const rows=items.map(i=>({ id:i.id||crypto.randomUUID(), owner_id:user.id, data:i, updated_at:new Date().toISOString() }));
      const { error } = await window.sb.from('items_v3').upsert(rows);
      if(error) console.error(error);
    }
    async function deleteCloud(id){
      const { error } = await window.sb.from('items_v3').delete().eq('id',id);
      if(error) console.error(error);
    }
  </script>
</body>
</html>
