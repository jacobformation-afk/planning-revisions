<!DOCTYPE html>
<html lang="fr" class="h-full" data-app-version="4.0">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0b1220" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <title>Planning de R√©visions ‚Äî v4</title>
  <style>
    /* ===== Design tokens ===== */
    :root{
      --bg: #0b1220; --bg-2:#0d1424; --bg-3:#0f1628;
      --card:#121a2b; --elev: rgba(0,0,0,.25);
      --muted:#a6b0c3; --text:#e9eef7; --text-weak:#cfe2ff;
      --primary:#4caf50; --accent:#2c3e50; --danger:#e74c3c;
      --border:#1e293b; --border-2:#243349;
      --focus:#60a5fa;
    }
    @media (prefers-color-scheme: light) {
      :root{ --bg:#f6f7fb; --bg-2:#f9faff; --bg-3:#ffffff; --card:#ffffff; --text:#0e1220; --text-weak:#334155; --border:#e2e8f0; --border-2:#e5e7eb; --elev: rgba(0,0,0,.06); }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";margin:0;color:var(--text);background:linear-gradient(180deg,var(--bg),var(--bg-2) 35%,var(--bg-3));}

    /* ===== Accessibility & motion ===== */
    :focus-visible{outline:2px solid var(--focus); outline-offset:2px; border-radius:10px}
    @media (prefers-reduced-motion: reduce){ *{animation-duration:0.01ms!important; animation-iteration-count:1!important; transition-duration:0.01ms!important; scroll-behavior:auto!important} }

    header{position:sticky;top:0;z-index:20;background:color-mix(in oklab, var(--bg) 80%, transparent);backdrop-filter:saturate(1.1) blur(8px);border-bottom:1px solid var(--border)}
    nav{display:flex;gap:.5rem;align-items:center;max-width:1100px;margin:0 auto;padding:.75rem 1rem}
    nav a, nav button{color:var(--text-weak);text-decoration:none;font-weight:600;padding:.5rem .75rem;border-radius:12px;border:1px solid var(--border-2);background:color-mix(in oklab, var(--card) 80%, transparent);cursor:pointer}
    nav a[aria-current="page"],nav a:hover,nav button:hover{background:color-mix(in oklab, var(--card) 100%, transparent)}
    main{max-width:1100px;margin:0 auto;padding:1rem}
    .tab{display:none}.tab.active{display:block}
    .grid{display:grid;gap:1rem}
    @media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1rem;box-shadow:0 10px 30px var(--elev)}
    h1,h2,h3{margin:.25rem 0 1rem}
    iframe{border:0;width:100%;border-radius:12px}
    input,select,textarea,button{width:100%;padding:.7rem .8rem;border-radius:12px;border:1px solid var(--border-2);background:var(--bg-3);color:inherit}
    textarea{min-height:90px}
    button{cursor:pointer;background:#1b8f3f;border:1px solid #1e9a45;font-weight:700}
    button.secondary{background:color-mix(in oklab, var(--card) 100%, transparent);border-color:var(--border-2)}
    button.danger{background:#7a1f1b;border-color:#8a241f}
    .row{display:flex;gap:.5rem;flex-wrap:wrap}.row>*{flex:1 1 220px}
    .list{max-height:420px;overflow:auto}
    .pill{display:inline-flex;align-items:center;gap:.5ch;background:color-mix(in oklab, var(--card) 80%, transparent);border:1px solid var(--border-2);border-radius:999px;padding:.2rem .6rem;font-size:.85rem;color:var(--text-weak)}
    .badge{display:inline-flex;align-items:center;gap:.4ch;border-radius:999px;padding:.1rem .5rem;font-weight:700;font-size:.75rem}
    .badge.rev{background:#10361f;border:1px solid #174b29;color:#b9f0c3}
    .badge.rendre{background:#3a1412;border:1px solid #4e1a17;color:#ffcdc7}
    .badge.prep{background:#102247;border:1px solid #183066;color:#cfe2ff}
    .badge.lect{background:#241451;border:1px solid #2e1a69;color:#e6d9ff}
    .tile{border:1px solid var(--border-2);background:var(--bg-3);border-radius:12px;padding:.75rem;margin:.5rem 0}
    .progress{background:color-mix(in oklab, var(--bg-2) 70%, transparent);border-radius:999px;overflow:hidden;height:10px;margin-top:6px}
    .bar{background:var(--primary);height:100%;transition:width .3s ease}
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0}
    .planning-table{width:100%;border-collapse:separate;border-spacing:0 12px}
    .planning-table th,.planning-table td{vertical-align:top;text-align:left}
    .planning-table th{font-size:.95rem;color:var(--text-weak);padding:.25rem .5rem}
    .planning-col{background:var(--bg-3);border:1px solid var(--border-2);border-radius:12px;padding:.75rem}
    .muted{color:var(--muted)}
    .hidden{display:none}

    /* Toasts */
    #toasts{position:fixed;inset:auto 1rem 1rem 1rem;display:grid;gap:.5rem;z-index:50}
    .toast{background:var(--card);border:1px solid var(--border);padding:.75rem 1rem;border-radius:10px;box-shadow:0 10px 20px var(--elev)}

    /* Dialog */
    dialog{border:1px solid var(--border);background:var(--card);color:inherit;border-radius:12px;padding:0;max-width:min(480px, 95vw)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .dlg-head{padding:1rem;border-bottom:1px solid var(--border)}
    .dlg-body{padding:1rem}
    .dlg-actions{display:flex;gap:.5rem;justify-content:flex-end;padding:1rem;border-top:1px solid var(--border)}

    /* Better focus on actionable controls inside list */
    .tile button{width:auto}
  </style>
</head>
<body>
  <header>
    <nav aria-label="Onglets">
      <a href="#accueil" data-tab="accueil">Accueil</a>
      <a href="#saisies" data-tab="saisies">Saisies du jour</a>
      <a href="#planning" data-tab="planning">Planning √† 5 jours</a>
      <a href="#agenda" data-tab="agenda">Agenda</a>
      <a href="#matieres" data-tab="matieres">Mati√®res</a>
      <div style="margin-left:auto; display:flex; gap:.5rem">
        <button id="btnLogin" class="secondary" type="button">Se connecter</button>
        <button id="btnLoginCode" class="secondary" type="button">Se connecter (code)</button>
        <button id="btnLogout" class="secondary" type="button" style="display:none">Se d√©connecter</button>
      </div>
    </nav>
  </header>

  <main>
    <h1 class="hidden">Planning de r√©visions</h1>
    <!-- ACCUEIL -->
    <section class="tab" id="accueil" role="tabpanel" aria-labelledby="tab-accueil">
      <div class="grid">
        <div class="card">
          <h2>Bonjour <span id="username">Octave</span></h2>
          <p class="muted">Bienvenue ‚Äî musique du jour.</p>
          <h3>üéµ Musique</h3>
          <iframe title="Lecteur Deezer" scrolling="no" allowtransparency="true"
            src="https://www.deezer.com/plugins/player?format=classic&autoplay=false&playlist=true&width=700&height=350&color=007FEB&layout=dark&size=medium&type=tracks&id=3135556&app_id=1"
            height="100"></iframe>
        </div>
      </div>
    </section>

    <!-- SAISIES -->
    <section class="tab" id="saisies" role="tabpanel" aria-labelledby="tab-saisies">
      <div class="card">
        <h2>Saisies du jour</h2>
        <div class="row" role="group" aria-label="Type et mati√®re">
          <label class="hidden" for="typeSelect">Type</label>
          <select id="typeSelect" aria-label="Type">
            <option value="revision">R√©vision</option>
            <option value="devoir_rendre">Devoir √† rendre</option>
            <option value="devoir_preparer">Devoir √† pr√©parer</option>
            <option value="lecture">Lecture</option>
          </select>
          <label class="hidden" for="matiereSelect">Mati√®re</label>
          <select id="matiereSelect" aria-label="Mati√®re"></select>
          <label class="hidden" for="titreInput">Titre</label>
          <input id="titreInput" placeholder="Titre (ex. DM fonctions / Lecture Candide)" />
        </div>
        <div class="row">
          <label class="hidden" for="descriptionInput">Description</label>
          <textarea id="descriptionInput" placeholder="Description / consignes / notes..."></textarea>
        </div>

        <!-- Sp√©cifiques par type -->
        <div id="formRevision" class="row">
          <label class="hidden" for="dateRevision">Date de r√©vision</label>
          <input id="dateRevision" type="date" aria-label="Date de r√©vision" />
          <div class="pill" aria-hidden="true">Jalons: 0,1,3,7,15,30 jours</div>
        </div>

        <div id="formRendre" class="row hidden">
          <label class="hidden" for="echeanceRendre">√âch√©ance</label>
          <input id="echeanceRendre" type="date" aria-label="√âch√©ance" />
          <label class="hidden" for="prioriteRendre">Priorit√©</label>
          <select id="prioriteRendre">
            <option value="1">Priorit√© normale</option>
            <option value="2">Haute</option>
            <option value="0">Basse</option>
          </select>
        </div>

        <div id="formPreparer" class="row hidden">
          <label class="hidden" for="echeancePreparer">√âch√©ance</label>
          <input id="echeancePreparer" type="date" aria-label="√âch√©ance" />
          <label class="hidden" for="dureeTotale">Dur√©e totale estim√©e</label>
          <input id="dureeTotale" type="number" min="15" step="5" placeholder="Dur√©e totale estim√©e (min)" />
          <button id="btnPlanifierAuto" class="secondary" style="width:auto" type="button">Planifier maintenant</button>
        </div>

        <div id="formLecture" class="row hidden">
          <label class="hidden" for="ouvrageTitre">Titre de l'ouvrage</label>
          <input id="ouvrageTitre" placeholder="Titre de l'ouvrage" />
          <label class="hidden" for="ouvrageAuteur">Auteur</label>
          <input id="ouvrageAuteur" placeholder="Auteur (optionnel)" />
          <label class="hidden" for="chapitresTotal">Nombre de chapitres</label>
          <input id="chapitresTotal" type="number" min="1" placeholder="Nombre de chapitres" />
          <label class="hidden" for="echeanceLecture">√âch√©ance lecture</label>
          <input id="echeanceLecture" type="date" aria-label="√âch√©ance lecture (optionnelle)" />
          <button id="btnRepartirLecture" class="secondary" style="width:auto" type="button">R√©partir maintenant</button>
        </div>

        <div class="toolbar" role="group" aria-label="Actions">
          <button id="btnSauver" type="button">Ajouter</button>
          <button class="secondary" id="btnExporter" type="button">Exporter JSON</button>
          <label class="pill" for="importInput">Importer JSON
            <input id="importInput" type="file" accept="application/json" class="hidden" />
          </label>
        </div>

        <div id="listeItems" class="list" role="list"></div>
      </div>
    </section>

    <!-- PLANNING -->
    <section class="tab" id="planning" role="tabpanel" aria-labelledby="tab-planning">
      <div class="card">
        <h2 style="text-align:center">Planning √† 5 jours</h2>
        <table class="planning-table" id="planningTable">
          <thead><tr id="planningHeader"></tr></thead>
          <tbody><tr id="planningRow"></tr></tbody>
        </table>
      </div>
    </section>

    <!-- AGENDA -->
    <section class="tab" id="agenda" role="tabpanel" aria-labelledby="tab-agenda">
      <div class="card">
        <h2>Agenda</h2>
        <div class="toolbar">
          <input id="rechercheAgenda" placeholder="Rechercher (mati√®re, titre, description)" />
          <select id="filtreMatiere"></select>
          <select id="filtreType">
            <option value="">Tous les types</option>
            <option value="revision">R√©vision</option>
            <option value="devoir_rendre">√Ä rendre</option>
            <option value="devoir_preparer">√Ä pr√©parer</option>
            <option value="lecture">Lecture</option>
          </select>
          <button class="secondary" id="btnAujourdHui" type="button">Aller √† aujourd'hui</button>
          <button class="secondary" id="btnICS" type="button" title="Exporter la semaine en .ics">Exporter .ics</button>
        </div>
        <div id="agendaContent" class="list"></div>
      </div>
    </section>

    <!-- MATIERES -->
    <section class="tab" id="matieres" role="tabpanel" aria-labelledby="tab-matieres">
      <div class="card">
        <h2>Mati√®res</h2>
        <div class="row">
          <input id="nouvelleMatiere" placeholder="Nouvelle mati√®re" type="text" />
          <button id="btnAjouterMatiere" type="button">Ajouter</button>
        </div>
        <ul id="listeMatieres" class="list"></ul>
      </div>
    </section>
  </main>

  <!-- Template pour un item -->
  <template id="itemTpl">
    <div class="tile" data-id="">
      <div class="row" style="align-items:center">
        <span class="badge" data-badge></span>
        <span class="pill" data-matiere></span>
        <span class="muted" data-info></span>
      </div>
      <h4 style="margin:.5rem 0" data-titre></h4>
      <p class="muted" data-desc></p>
      <div class="progress" aria-hidden="true"><div class="bar" data-bar style="width:0%"></div></div>
      <div class="row" style="margin-top:.5rem">
        <button data-edit class="secondary" type="button">Modifier</button>
        <button data-done class="secondary" type="button">Marquer termin√©</button>
        <button data-pluschap class="secondary hidden" type="button">+1 chapitre lu</button>
        <button data-delete class="danger" type="button">Supprimer</button>
      </div>
    </div>
  </template>

  <!-- Dialogs -->
  <dialog id="dlgLoginEmail" aria-labelledby="dlgLoginTitle">
    <div class="dlg-head"><h3 id="dlgLoginTitle">Connexion par email</h3></div>
    <form method="dialog">
      <div class="dlg-body">
        <label for="inpEmail" class="hidden">Email</label>
        <input id="inpEmail" type="email" placeholder="mon@email.fr" autocomplete="email" required />
        <p class="muted" id="loginHelper">Un lien de connexion vous sera envoy√©.</p>
      </div>
      <div class="dlg-actions">
        <button value="cancel" class="secondary" type="submit">Annuler</button>
        <button id="dlgLoginSend" value="ok" type="submit">Envoyer</button>
      </div>
    </form>
  </dialog>

  <dialog id="dlgOtp" aria-labelledby="dlgOtpTitle">
    <div class="dlg-head"><h3 id="dlgOtpTitle">Code √† 6 chiffres</h3></div>
    <form method="dialog">
      <div class="dlg-body">
        <input id="inpOtpEmail" type="email" placeholder="Email" autocomplete="email" required />
        <input id="inpOtp" inputmode="numeric" pattern="[0-9]{6}" maxlength="6" placeholder="000000" required />
      </div>
      <div class="dlg-actions">
        <button value="cancel" class="secondary" type="submit">Annuler</button>
        <button id="dlgOtpVerify" value="ok" type="submit">V√©rifier</button>
      </div>
    </form>
  </dialog>

  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <!-- Supabase (CDN) + config: utilisez des variables d'environnement c√¥t√© build/d√©ploiement. -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" integrity="sha384-fakehash" crossorigin="anonymous"></script>
  <script>
    // ======= Configuration =======
    // ‚ö†Ô∏è Remplacez ces valeurs au build (ex: via Vite/Next) et ne commitez jamais vos cl√©s en clair.
    const SUPABASE_URL = window.__SB_URL__ || "";
    const SUPABASE_ANON_KEY = window.__SB_ANON__ || "";
    const REDIRECT_URL = (location.origin.match(/vercel\.app$/) ? location.origin : location.origin);
    const sb = (SUPABASE_URL && SUPABASE_ANON_KEY) ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

    // ======= Utilitaires =======
    const JALONS=[0,1,3,7,15,30], FR='fr-FR';
    const fmtDateLabel=d=>new Intl.DateTimeFormat(FR,{weekday:'long',day:'2-digit',month:'long',year:'numeric'}).format(d);
    const toLocalDate=s=>new Date(`${s}T00:00:00`);
    const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x};
    const isoDate=d=>d.toISOString().slice(0,10);
    const todayIso=()=>isoDate(new Date());
    // XSS: √©chappement plus robuste + trim
    const escapeHtml=(str='')=>String(str).replace(/[&<>"']/g,ch=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
    // Debounce
    const debounce=(fn,ms=200)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

    // ======= Store local =======
    const store={
      get matieres(){return JSON.parse(localStorage.getItem('matieres'))||['Math√©matiques','Physique-chimie','Fran√ßais','Histoire-g√©ographie','Anglais','Espagnol','Enseignement moral et civique','Techno','Enseignement Sp√©cifique','EPS']},
      set matieres(v){localStorage.setItem('matieres',JSON.stringify(v))},
      get items(){return JSON.parse(localStorage.getItem('items_v4'))||[]},
      set items(v){localStorage.setItem('items_v4',JSON.stringify(v))}
    };

    // Migration depuis v3 si pr√©sent
    (function migrate(){
      if(!localStorage.getItem('items_v4')){
        const v3 = JSON.parse(localStorage.getItem('items_v3'))||[];
        if(v3.length){ localStorage.setItem('items_v4', JSON.stringify(v3)); }
      }
    })();

    // ======= √âl√©ments =======
    const qs=id=>document.getElementById(id);
    const els={
      tabs:[...document.querySelectorAll('nav a[data-tab]')],
      typeSelect:qs('typeSelect'), matiereSelect:qs('matiereSelect'), titreInput:qs('titreInput'), descriptionInput:qs('descriptionInput'),
      formRevision:qs('formRevision'), formRendre:qs('formRendre'), formPreparer:qs('formPreparer'), formLecture:qs('formLecture'),
      dateRevision:qs('dateRevision'), echeanceRendre:qs('echeanceRendre'), prioriteRendre:qs('prioriteRendre'),
      echeancePreparer:qs('echeancePreparer'), dureeTotale:qs('dureeTotale'), btnPlanifierAuto:qs('btnPlanifierAuto'),
      ouvrageTitre:qs('ouvrageTitre'), ouvrageAuteur:qs('ouvrageAuteur'), chapitresTotal:qs('chapitresTotal'), echeanceLecture:qs('echeanceLecture'), btnRepartirLecture:qs('btnRepartirLecture'),
      btnSauver:qs('btnSauver'), listeItems:qs('listeItems'), planningHeader:qs('planningHeader'), planningRow:qs('planningRow'), agendaContent:qs('agendaContent'),
      rechercheAgenda:qs('rechercheAgenda'), filtreMatiere:qs('filtreMatiere'), filtreType:qs('filtreType'),
      nouvelleMatiere:qs('nouvelleMatiere'), listeMatieres:qs('listeMatieres'),
      btnICS:qs('btnICS')
    };

    // ======= Tabs avec hash (deep-link + persistance) =======
    function setActiveTab(id){
      document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.id===id));
      els.tabs.forEach(a=>a.setAttribute('aria-current', a.dataset.tab===id ? 'page' : 'false'));
      localStorage.setItem('active_tab', id);
    }
    function handleHash(){ const id=(location.hash||'#accueil').slice(1); setActiveTab(id); }
    addEventListener('hashchange', handleHash);
    els.tabs.forEach(a=>a.addEventListener('click', e=>{e.preventDefault(); location.hash = a.getAttribute('href'); }));

    // ======= Mati√®res UI =======
    function renderMatieres(){
      const ms=[...store.matieres].sort((a,b)=>a.localeCompare(b,'fr'));
      els.matiereSelect.innerHTML=ms.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('');
      els.filtreMatiere.innerHTML=`<option value="">Toutes les mati√®res</option>`+ms.map(m=>`<option>${escapeHtml(m)}</option>`).join('');
      els.listeMatieres.innerHTML='';
      ms.forEach(m=>{
        const utilisee=store.items.some(r=>r.matiere===m);
        const li=document.createElement('li'); li.innerHTML=`<span class="pill">${escapeHtml(m)}</span>`;
        if(!utilisee){
          const btn=document.createElement('button'); btn.textContent='Supprimer'; btn.className='danger'; btn.style.width='auto';
          btn.addEventListener('click',()=>{ confirmDialog('Supprimer cette mati√®re ?').then(ok=>{ if(ok){ store.matieres=store.matieres.filter(x=>x!==m); renderMatieres(); showToast('Mati√®re supprim√©e'); }}); });
          li.append(' ',btn);
        }
        els.listeMatieres.appendChild(li);
      });
    }
    qs('btnAjouterMatiere').addEventListener('click',()=>{
      const m=els.nouvelleMatiere.value.trim(); if(m&&!store.matieres.includes(m)){ store.matieres=[...store.matieres,m]; els.nouvelleMatiere.value=''; renderMatieres(); showToast('Mati√®re ajout√©e'); }
    });

    // ======= Items CRUD =======
    let addItem=obj=>{store.items=[...store.items,obj]};
    let updateItem=(id,patch)=>{store.items=store.items.map(i=>i.id===id?{...i,...patch}:i)};
    let deleteItem=id=>{store.items=store.items.filter(i=>i.id!==id)};

    function switchTypeUI(){
      const t=els.typeSelect.value;
      els.formRevision.classList.toggle('hidden',t!=='revision');
      els.formRendre.classList.toggle('hidden',t!=='devoir_rendre');
      els.formPreparer.classList.toggle('hidden',t!=='devoir_preparer');
      els.formLecture.classList.toggle('hidden',t!=='lecture');
    }
    els.typeSelect.addEventListener('change',switchTypeUI);
    els.dateRevision.value=todayIso(); els.echeanceRendre.value=todayIso(); els.echeancePreparer.value=todayIso(); els.echeanceLecture.value='';

    let editingId=null, pendingSessions=null, pendingRepartition=null;

    function clearForm(){
      editingId=null; pendingSessions=null; pendingRepartition=null; qs('btnSauver').textContent='Ajouter';
      els.titreInput.value=''; els.descriptionInput.value=''; els.dateRevision.value=todayIso(); els.echeanceRendre.value=todayIso();
      els.echeancePreparer.value=todayIso(); els.dureeTotale.value=''; els.ouvrageTitre.value=''; els.ouvrageAuteur.value='';
      els.chapitresTotal.value=''; els.echeanceLecture.value=''; els.typeSelect.value='revision'; switchTypeUI();
    }

    qs('btnSauver').addEventListener('click',()=>{
      const type=els.typeSelect.value, matiere=els.matiereSelect.value;
      const titre=els.titreInput.value.trim()||(type==='lecture'?(els.ouvrageTitre.value.trim()||'Lecture'):'Sans titre');
      const description=els.descriptionInput.value.trim();
      if(!matiere) return showToast('Choisis une mati√®re.', true);
      let payload={id:editingId||crypto.randomUUID(),type,matiere,titre,description,dateCreation:Date.now(),etat:'a_faire'};

      if(type==='revision'){
        const baseDate=els.dateRevision.value; if(!baseDate) return showToast('Date requise.', true);
        payload={...payload,baseDate,jalons:[...JALONS]};
      }
      if(type==='devoir_rendre'){
        const echeance=els.echeanceRendre.value; if(!echeance) return showToast('√âch√©ance requise.', true);
        payload={...payload,echeance,priorite:Number(els.prioriteRendre.value),progress:0};
      }
      if(type==='devoir_preparer'){
        const echeance=els.echeancePreparer.value; if(!echeance) return showToast('√âch√©ance requise.', true);
        const dureeTotale=Number(els.dureeTotale.value||0); if(!dureeTotale) return showToast('Indique la dur√©e totale estim√©e.', true);
        payload={...payload,echeance,dureeTotaleEstimee:dureeTotale,sessions:pendingSessions||[]};
      }
      if(type==='lecture'){
        const titreO=els.ouvrageTitre.value.trim(); if(!titreO) return showToast("Titre de l'ouvrage requis.", true);
        const chapTotal=Number(els.chapitresTotal.value||0); if(!chapTotal) return showToast('Nombre de chapitres requis.', true);
        const echeance=els.echeanceLecture.value||null;
        payload={...payload,ouvrage:{titre:titreO,auteur:els.ouvrageAuteur.value.trim()||''},chapitresTotal:chapTotal,chapitresLus:0,echeance,repartition:pendingRepartition||[]};
      }

      if(editingId) updateItem(editingId,payload); else addItem(payload);
      clearForm(); refreshAll(); showToast('Enregistr√©');
    });

    els.btnPlanifierAuto.addEventListener('click',()=>{
      const echeance=els.echeancePreparer.value, dureeTotale=Number(els.dureeTotale.value||0);
      if(!echeance||!dureeTotale) return showToast('√âch√©ance et dur√©e requises.', true);
      const start=toLocalDate(todayIso()), end=toLocalDate(echeance);
      const days=Math.max(1,Math.ceil((end-start)/86400000)), chunk=30, sessionsCount=Math.max(1,Math.ceil(dureeTotale/chunk));
      const sessions=Array.from({length:sessionsCount},(_,i)=>({date:isoDate(addDays(start,Math.round(i*(days-1)/Math.max(1,sessionsCount-1)))),duree:chunk,fait:false}));
      if(editingId){const it=store.items.find(x=>x.id===editingId); if(it&&it.type==='devoir_preparer'){updateItem(editingId,{sessions}); refreshAll(); return showToast(`Plan cr√©√©: ${sessions.length} sessions de ${chunk} min.`);} }
      pendingSessions=sessions; showToast(`Plan pr√™t: ${sessions.length} sessions seront ajout√©es √† l'enregistrement.`);
    });

    els.btnRepartirLecture.addEventListener('click',()=>{
      const chapTotal=Number(els.chapitresTotal.value||0), echeance=els.echeanceLecture.value;
      if(!(chapTotal&&echeance)) return showToast('Indique le nombre de chapitres et une √©ch√©ance.', true);
      const start=toLocalDate(todayIso()), end=toLocalDate(echeance), days=Math.max(1,Math.ceil((end-start)/86400000));
      const base=Math.floor(chapTotal/days), extra=chapTotal%days;
      const repartition=Array.from({length:days},(_,i)=>{const nb=base+(i<extra?1:0);return{date:isoDate(addDays(start,i)),chapitres:nb,fait:false}}).filter(p=>p.chapitres>0);
      if(editingId){const it=store.items.find(x=>x.id===editingId); if(it&&it.type==='lecture'){updateItem(editingId,{repartition}); refreshAll(); return showToast(`R√©partition cr√©√©e: ${repartition.length} jours.`);} }
      pendingRepartition=repartition; showToast(`R√©partition pr√™te: ${repartition.length} jours seront ajout√©s.`);
    });

    function badgeFor(t){const s=document.createElement('span'); s.className='badge '+(t==='revision'?'rev':t==='devoir_rendre'?'rendre':t==='devoir_preparer'?'prep':'lect'); s.textContent=t==='revision'?'R√©vision':t==='devoir_rendre'?'√Ä rendre':t==='devoir_preparer'?'√Ä pr√©parer':'Lecture'; return s;}
    function percentFor(item){
      if(item.type==='revision'){const today=toLocalDate(todayIso()), base=toLocalDate(item.baseDate); const diff=Math.round((today-base)/86400000); const idx=item.jalons.findIndex(j=>j===diff); return idx>=0?Math.round(((idx+1)/item.jalons.length)*100):0;}
      if(item.type==='devoir_rendre') return Number(item.progress||0);
      if(item.type==='devoir_preparer'){const t=(item.sessions||[]).length||0, d=(item.sessions||[]).filter(s=>s.fait).length; return t?Math.round(100*d/t):0;}
      if(item.type==='lecture') return item.chapitresTotal?Math.round(100*(item.chapitresLus||0)/item.chapitresTotal):0;
      return 0;
    }
    function infoFor(it){
      if(it.type==='revision') return `Base: ${fmtDateLabel(toLocalDate(it.baseDate))}`;
      if(it.type==='devoir_rendre') return `√âch√©ance: ${fmtDateLabel(toLocalDate(it.echeance))}`;
      if(it.type==='devoir_preparer') return `√âch√©ance: ${fmtDateLabel(toLocalDate(it.echeance))}`;
      if(it.type==='lecture'){const p=[`${it.chapitresLus||0}/${it.chapitresTotal} chap.`]; if(it.echeance) p.push(`√âch√©ance: ${fmtDateLabel(toLocalDate(it.echeance))}`); return p.join(' ‚Äî ');} return '';
    }

    function renderItems(){
      const items=[...store.items].sort((a,b)=>{const pa=(a.type==='devoir_rendre'||a.type==='devoir_preparer')?(a.echeance||'9999'):'9999'; const pb=(b.type==='devoir_rendre'||b.type==='devoir_preparer')?(b.echeance||'9999'):'9999'; return pa.localeCompare(pb)||(b.dateCreation-a.dateCreation)});
      els.listeItems.innerHTML=''; const tpl=document.getElementById('itemTpl');
      items.forEach(it=>{
        const node=tpl.content.cloneNode(true), root=node.querySelector('.tile'); root.dataset.id=it.id;
        const b=badgeFor(it.type); node.querySelector('[data-badge]').replaceWith(b);
        node.querySelector('[data-matiere]').textContent=it.matiere;
        node.querySelector('[data-info]').textContent=infoFor(it);
        node.querySelector('[data-titre]').textContent=it.titre;
        node.querySelector('[data-desc]').textContent=it.description||'';
        node.querySelector('[data-bar]').style.width=percentFor(it)+'%';
        node.querySelector('[data-edit]').addEventListener('click',()=>startEdit(it));
        node.querySelector('[data-done]').addEventListener('click',()=>{updateItem(it.id,{etat:'termine',progress:100}); refreshAll(); showToast('Marqu√© termin√©');});
        node.querySelector('[data-delete]').addEventListener('click',()=>{ confirmDialog('Supprimer ?').then(ok=>{ if(ok){ deleteItem(it.id); refreshAll(); showToast('Supprim√©'); } }); });
        const plus=node.querySelector('[data-pluschap]');
        if(it.type==='lecture'){
          plus.classList.remove('hidden');
          plus.addEventListener('click',()=>{const v=Math.min(it.chapitresTotal,(it.chapitresLus||0)+1); updateItem(it.id,{chapitresLus:v}); refreshAll();});
        }
        els.listeItems.appendChild(node);
      });
    }

    function startEdit(it){
      editingId=it.id; pendingSessions=null; pendingRepartition=null; qs('btnSauver').textContent='Mettre √† jour';
      els.typeSelect.value=it.type; switchTypeUI();
      els.matiereSelect.value=it.matiere;
      els.titreInput.value=it.titre;
      els.descriptionInput.value=it.description||'';
      if(it.type==='revision'){ els.dateRevision.value=it.baseDate; }
      if(it.type==='devoir_rendre'){ els.echeanceRendre.value=it.echeance; els.prioriteRendre.value=String(it.priorite??1); }
      if(it.type==='devoir_preparer'){ els.echeancePreparer.value=it.echeance; els.dureeTotale.value=it.dureeTotaleEstimee||''; }
      if(it.type==='lecture'){
        els.ouvrageTitre.value=it.ouvrage?.titre||''; els.ouvrageAuteur.value=it.ouvrage?.auteur||'';
        els.chapitresTotal.value=it.chapitresTotal||''; els.echeanceLecture.value=it.echeance||'';
      }
      location.hash = '#saisies';
    }

    // ======= Planning (5 jours) =======
    function renderPlanning(){
      const start=toLocalDate(todayIso());
      const days=Array.from({length:5},(_,i)=>{const d=addDays(start,i);return{date:isoDate(d),label:fmtDateLabel(d),html:[]};});

      // R√©visions (jalons)
      store.items.filter(i=>i.type==='revision').forEach(r=>{
        const base=toLocalDate(r.baseDate);
        r.jalons.forEach((j,idx)=>{
          const d=isoDate(addDays(base,j));
          const col=days.find(x=>x.date===d); if(!col) return;
          const prog=Math.round(((idx+1)/r.jalons.length)*100);
          col.html.push(`<div class="tile"><span class="badge rev">R√©vision</span> <strong>${escapeHtml(r.matiere)}</strong><br><em>${escapeHtml(r.titre)}</em><div class="progress"><div class="bar" style="width:${prog}%"></div></div></div>`);
        });
      });

      // √Ä pr√©parer (sessions + √©ch√©ance)
      store.items.filter(i=>i.type==='devoir_preparer').forEach(p=>{
        (p.sessions||[]).forEach(s=>{
          const col=days.find(x=>x.date===s.date); if(!col) return;
          col.html.push(`<div class="tile"><span class="badge prep">Pr√©parer</span> <strong>${escapeHtml(p.matiere)}</strong> ‚Äî ${escapeHtml(p.titre)}<br><span class="muted">Session ${s.duree} min</span><div class="progress"><div class="bar" style="width:${s.fait?100:0}%"></div></div></div>`);
        });
        const colE=days.find(x=>x.date===p.echeance); if(colE) colE.html.push(`<div class="tile"><span class="badge prep">√âch√©ance</span> <strong>${escapeHtml(p.matiere)}</strong> ‚Äî ${escapeHtml(p.titre)}</div>`);
      });

      // √Ä rendre (√©ch√©ance)
      store.items.filter(i=>i.type==='devoir_rendre').forEach(dv=>{
        const col=days.find(x=>x.date===dv.echeance); if(!col) return;
        col.html.push(`<div class="tile"><span class="badge rendre">√Ä rendre</span> <strong>${escapeHtml(dv.matiere)}</strong> ‚Äî ${escapeHtml(dv.titre)}<div class="progress"><div class="bar" style="width:${Number(dv.progress||0)}%"></div></div></div>`);
      });

      // Lecture (r√©partition)
      store.items.filter(i=>i.type==='lecture').forEach(le=>{
        (le.repartition||[]).forEach(part=>{
          const col=days.find(x=>x.date===part.date); if(!col) return;
          col.html.push(`<div class="tile"><span class="badge lect">Lecture</span> <strong>${escapeHtml(le.ouvrage?.titre||le.titre)}</strong> ‚Äî ${part.chapitres} chap.</div>`);
        });
      });

      els.planningHeader.innerHTML=''; els.planningRow.innerHTML='';
      days.forEach(d=>{
        const th=document.createElement('th'); th.textContent=d.label; els.planningHeader.appendChild(th);
        const td=document.createElement('td'); td.className='planning-col'; td.innerHTML=d.html.join('')||'<em class="muted">Aucune t√¢che</em>'; els.planningRow.appendChild(td);
      });
    }

    // ======= Agenda =======
    function renderAgenda(){
      const itemsByDate={};
      store.items.filter(i=>i.type==='revision').forEach(r=>{
        const base=toLocalDate(r.baseDate);
        r.jalons.forEach((j,idx)=>{
          const d=isoDate(addDays(base,j));
          (itemsByDate[d] ||= []).push({type:'revision', matiere:r.matiere, titre:r.titre, desc:r.description, prog:Math.round(((idx+1)/r.jalons.length)*100)});
        });
      });
      store.items.filter(i=>i.type==='devoir_preparer').forEach(p=>{
        (p.sessions||[]).forEach(s=>{ (itemsByDate[s.date] ||= []).push({type:'devoir_preparer', matiere:p.matiere, titre:p.titre, desc:`Session ${s.duree} min`, prog: s.fait?100:0}); });
        (itemsByDate[p.echeance] ||= []).push({type:'devoir_preparer', matiere:p.matiere, titre:p.titre, desc:'√âch√©ance', prog: percentFor(p)});
      });
      store.items.filter(i=>i.type==='devoir_rendre').forEach(dv=>{
        (itemsByDate[dv.echeance] ||= []).push({type:'devoir_rendre', matiere:dv.matiere, titre:dv.titre, desc:'√Ä rendre', prog:Number(dv.progress||0)});
      });
      store.items.filter(i=>i.type==='lecture').forEach(le=>{
        (le.repartition||[]).forEach(part=>{ (itemsByDate[part.date] ||= []).push({type:'lecture', matiere:le.matiere, titre:le.ouvrage?.titre||le.titre, desc:`${part.chapitres} chap.`, prog: percentFor(le)}); });
      });

      const q=els.rechercheAgenda.value.trim().toLowerCase();
      const fm=els.filtreMatiere.value, ft=els.filtreType.value;

      const dates=Object.keys(itemsByDate).sort();
      els.agendaContent.innerHTML='';
      dates.forEach((d,i)=>{
        let list=itemsByDate[d];
        if(fm) list=list.filter(x=>x.matiere===fm);
        if(ft) list=list.filter(x=>x.type===ft);
        if(q) list=list.filter(x=>[x.matiere,x.titre,x.desc].join(' ').toLowerCase().includes(q));
        if(!list.length) return;
        const wrap=document.createElement('div');
        wrap.dataset.date=d;
        wrap.style.background=i%2? 'var(--bg-2)' : 'var(--bg)';
        wrap.style.padding='10px'; wrap.style.marginBottom='8px';
        wrap.innerHTML=`<h4 style="margin:.25rem 0">${fmtDateLabel(toLocalDate(d))}</h4>`;
        list.forEach(p=>{
          const tile=document.createElement('div'); tile.className='tile';
          const b=badgeFor(p.type).outerHTML;
          tile.innerHTML=`${b} <strong>${escapeHtml(p.matiere)}</strong><br><em>${escapeHtml(p.titre)}</em><br><span class="muted">${escapeHtml(p.desc||'')}</span><div class="progress"><div class="bar" style="width:${p.prog||0}%"></div></div>`;
          wrap.appendChild(tile);
        });
        els.agendaContent.appendChild(wrap);
      });
    }

    qs('btnAujourdHui').addEventListener('click',()=>{
      const today=todayIso(); els.agendaContent.querySelector(`[\u005bdata-date="${today}"]`)?.scrollIntoView({behavior:'smooth',block:'start'});
    });
    els.rechercheAgenda.addEventListener('input', debounce(renderAgenda, 150));
    els.filtreMatiere.addEventListener('change', renderAgenda);
    els.filtreType.addEventListener('change', renderAgenda);

    // ======= Export / Import =======
    qs('btnExporter').addEventListener('click',()=>{
      const blob=new Blob([JSON.stringify({matieres:store.matieres,items:store.items},null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=`planning-v4-${todayIso()}.json`; a.click(); URL.revokeObjectURL(url);
    });
    qs('importInput').addEventListener('change',e=>{
      const file=e.target.files?.[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=()=>{
        try{
          const data=JSON.parse(reader.result);
          if(Array.isArray(data.matieres)) store.matieres=data.matieres;
          if(Array.isArray(data.items)) store.items=data.items.map(x=>x.id?x:{...x,id:crypto.randomUUID()});
          renderMatieres(); refreshAll(); showToast('Import effectu√©');
        }catch(err){ showToast('Fichier invalide.', true); }
      };
      reader.readAsText(file);
    });

    // ======= Export ICS (semaine courante des 5 jours) =======
    els.btnICS.addEventListener('click',()=>{
      const start=toLocalDate(todayIso());
      const items=[];
      const push=(date, title, desc)=>{ items.push({date, title, desc}); };
      store.items.forEach(it=>{
        if(it.type==='revision'){
          const base=toLocalDate(it.baseDate); JALONS.forEach(j=>{ const d=isoDate(addDays(base,j)); if(d>=isoDate(start) && d<=isoDate(addDays(start,4))) push(d, `R√©vision ${it.matiere} ‚Äî ${it.titre}`, it.description||''); });
        }else if(it.type==='devoir_preparer'){
          (it.sessions||[]).forEach(s=>{ if(s.date>=isoDate(start) && s.date<=isoDate(addDays(start,4))) push(s.date, `Pr√©parer ${it.matiere} ‚Äî ${it.titre}`, `Session ${s.duree} min`); });
          if(it.echeance>=isoDate(start) && it.echeance<=isoDate(addDays(start,4))) push(it.echeance, `√âch√©ance ${it.matiere} ‚Äî ${it.titre}`, '');
        }else if(it.type==='devoir_rendre'){
          if(it.echeance>=isoDate(start) && it.echeance<=isoDate(addDays(start,4))) push(it.echeance, `√Ä rendre ${it.matiere} ‚Äî ${it.titre}`, '');
        }else if(it.type==='lecture'){
          (it.repartition||[]).forEach(p=>{ if(p.date>=isoDate(start) && p.date<=isoDate(addDays(start,4))) push(p.date, `Lecture ‚Äî ${it.ouvrage?.titre||it.titre}`, `${p.chapitres} chap.`); });
        }
      });

      const pad=n=>String(n).padStart(2,'0');
      const dtstamp = new Date();
      const icsEvents = items.map(ev=>{
        const d = toLocalDate(ev.date);
        const dt = `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
        return `BEGIN:VEVENT\nDTSTAMP:${dtstamp.toISOString().replace(/[-:]/g,'').split('.')[0]}Z\nUID:${crypto.randomUUID()}\nDTSTART;VALUE=DATE:${dt}\nSUMMARY:${ev.title.replace(/\n/g,' ')}\nDESCRIPTION:${(ev.desc||'').replace(/\n/g,' ')}\nEND:VEVENT`;
      }).join('\n');
      const ics = `BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Planning v4//FR\nCALSCALE:GREGORIAN\n${icsEvents}\nEND:VCALENDAR`;
      const blob = new Blob([ics],{type:'text/calendar'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`planning-5jours-${todayIso()}.ics`; a.click(); URL.revokeObjectURL(url);
    });

    // ======= Initialisation =======
    function refreshAll(){ renderItems(); renderPlanning(); renderAgenda(); renderMatieres(); }
    switchTypeUI(); refreshAll(); handleHash();

    // ======= Auth & Sync Supabase (facultatif si cl√©s absentes) =======
    const btnLogin=document.getElementById('btnLogin');
    const btnLoginCode=document.getElementById('btnLoginCode');
    const btnLogout=document.getElementById('btnLogout');
    let mode='local'; // 'local' | 'cloud'

    function toggleAuthButtons(authenticated){
      btnLogin.style.display = authenticated ? 'none' : '';
      btnLoginCode.style.display = authenticated ? 'none' : '';
      btnLogout.style.display = authenticated ? '' : 'none';
    }

    // Dialog helpers
    function confirmDialog(message){
      return new Promise(res=>{
        const d=document.createElement('dialog');
        d.innerHTML=`<div class="dlg-head"><h3>Confirmation</h3></div><div class="dlg-body"><p>${escapeHtml(message)}</p></div><div class="dlg-actions"><button value="cancel" class="secondary">Annuler</button><button value="ok">Confirmer</button></div>`;
        document.body.appendChild(d); d.showModal();
        d.addEventListener('click', e=>{ if(e.target.tagName==='BUTTON'){ const v=e.target.getAttribute('value'); d.close(v); } });
        d.addEventListener('close', ()=>{ res(d.returnValue==='ok'); d.remove(); });
      });
    }
    function showToast(msg, isError=false){
      const wrap=document.getElementById('toasts');
      const t=document.createElement('div'); t.className='toast'; if(isError) t.style.borderColor='var(--danger)';
      t.textContent=msg; wrap.appendChild(t);
      setTimeout(()=>{ t.remove(); }, 2800);
    }

    if(sb){
      btnLogin?.addEventListener('click', async ()=>{
        const dlg = document.getElementById('dlgLoginEmail'); dlg.showModal();
        dlg.addEventListener('close', async ()=>{
          if(dlg.returnValue==='ok'){
            const email = document.getElementById('inpEmail').value.trim(); if(!email) return;
            const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: REDIRECT_URL, shouldCreateUser: true } });
            if(error) return showToast('Erreur: '+error.message, true);
            showToast('V√©rifie ta bo√Æte mail.');
          }
        }, { once:true });
      });

      btnLoginCode?.addEventListener('click', async ()=>{
        const dlg = document.getElementById('dlgOtp'); dlg.showModal();
        dlg.addEventListener('close', async ()=>{
          if(dlg.returnValue==='ok'){
            const email = document.getElementById('inpOtpEmail').value.trim();
            const token = document.getElementById('inpOtp').value.trim();
            if(!email || !token) return;
            const { error: e1 } = await sb.auth.signInWithOtp({ email, options:{ shouldCreateUser: true } });
            if (e1) return showToast('Erreur envoi code: '+e1.message, true);
            const { error: e2 } = await sb.auth.verifyOtp({ email, token, type: 'email' });
            if (e2) return showToast('Erreur v√©rification code: '+e2.message, true);
            showToast('Connexion r√©ussie !');
          }
        }, { once:true });
      });

      btnLogout?.addEventListener('click', async ()=>{
        await sb.auth.signOut();
        mode='local'; toggleAuthButtons(false); showToast('D√©connect√©.');
      });

      async function ensureProfile(user){
        try{ await sb.from('profiles').upsert({ id:user.id, email:user.email }).select().single(); }catch(e){ console.warn(e); }
      }
      async function maybeMigrateLocalToCloud(user){
        const { data:rows, error } = await sb.from('items_v4').select('id').limit(1);
        if(error){ console.error(error); return; }
        if(rows && rows.length) return;
        const localItems=store.items||[]; if(!localItems.length) return;
        const upserts=localItems.map(it=>({ id:it.id||crypto.randomUUID(), owner_id:user.id, data:it }));
        const { error:e2 } = await sb.from('items_v4').upsert(upserts);
        if(e2){ console.error(e2); return; }
        mode='cloud'; showToast('Migration effectu√©e en ligne.');
      }
      async function loadFromCloud(user){
        const { data, error } = await sb.from('items_v4').select('id,data,updated_at').eq('owner_id',user.id).order('created_at',{ascending:true});
        if(error){ console.error(error); return; }
        const items=(data||[]).map(r=>({ ...r.data, id:r.data.id||r.id }));
        store.items=items; mode='cloud'; refreshAll();
      }

      sb.auth.onAuthStateChange(async (_ev, session)=>{
        const user=session?.user||null;
        toggleAuthButtons(!!user);
        if(user){ await ensureProfile(user); await maybeMigrateLocalToCloud(user); await loadFromCloud(user); }
        else { mode='local'; }
      });

      const _addItem=addItem, _updateItem=updateItem, _deleteItem=deleteItem;
      addItem=(obj)=>{ _addItem(obj); if(mode==='cloud') upsertCloud([obj]); };
      updateItem=(id,patch)=>{ _updateItem(id,patch); if(mode==='cloud'){ const it=store.items.find(i=>i.id===id); if(it) upsertCloud([it]); } };
      deleteItem=(id)=>{ const it=store.items.find(i=>i.id===id); _deleteItem(id); if(mode==='cloud'&&it) deleteCloud(id); };

      async function upsertCloud(items){
        const { data:{ user } } = await sb.auth.getUser();
        if(!user) return;
        const rows=items.map(i=>({ id:i.id||crypto.randomUUID(), owner_id:user.id, data:i, updated_at:new Date().toISOString() }));
        const { error } = await sb.from('items_v4').upsert(rows);
        if(error) console.error(error);
      }
      async function deleteCloud(id){
        const { error } = await sb.from('items_v4').delete().eq('id',id);
        if(error) console.error(error);
      }
    } else {
      // Si pas de cl√©s fournies : masquer les boutons d'auth
      btnLogin.style.display='none'; btnLoginCode.style.display='none';
    }
  </script>
</body>
</html>
